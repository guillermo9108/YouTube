<?php
/**
 * StreamPay - Core Controller V10.1
 */

ini_set('display_errors', 0);
ini_set('log_errors', 1);
error_reporting(E_ALL);

if (ob_get_level() == 0) ob_start();

function respond($success, $data = null, $error = null) {
    $res = ['success' => $success, 'data' => $data, 'error' => $error];
    while (ob_get_level() > 0) ob_end_clean();
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode($res, JSON_UNESCAPED_UNICODE);
    exit();
}

// Global Exception Handler to capture internal bugs in debug_log.txt
set_exception_handler(function($e) {
    if (function_exists('write_log')) {
        write_log("FATAL EXCEPTION: " . $e->getMessage() . " in " . $e->getFile() . ":" . $e->getLine(), 'CRITICAL');
    }
    respond(false, null, "Error interno del servidor. Por favor, contacte al administrador.");
});

set_error_handler(function($errno, $errstr, $errfile, $errline) {
    if (!(error_reporting() & $errno)) return false;
    if (function_exists('write_log')) {
        write_log("PHP ERROR ($errno): $errstr in $errfile:$errline", 'ERROR');
    }
    return false;
});

header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { exit(); }

$json_input = json_decode(file_get_contents('php://input'), true) ?? [];
$input = array_merge($_GET, $_POST, $json_input);

$required_files = ['functions_schema.php', 'functions_utils.php', 'functions_auth.php', 'functions_videos.php', 'functions_interactions.php', 'functions_market.php', 'functions_admin.php', 'functions_payment.php'];
foreach ($required_files as $file) { if (file_exists($file)) { @require_once $file; } }

$action = $input['action'] ?? null;
$configFile = 'db_config.json';

if ($action === 'check_installation') respond(true, ['status' => file_exists($configFile) ? 'installed' : 'not_installed']);
if (!file_exists($configFile)) respond(false, null, 'No instalado');

$db_config = json_decode(file_get_contents($configFile), true);
try {
    $pdo = new PDO("mysql:host={$db_config['host']};port={$db_config['port']};dbname={$db_config['name']};charset=utf8mb4", $db_config['user'], $db_config['password'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION, PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
} catch (PDOException $e) { 
    if (function_exists('write_log')) write_log("DB Connection Failed: " . $e->getMessage(), 'CRITICAL');
    respond(false, null, 'Error DB: ' . $e->getMessage()); 
}

try {
    switch ($action) {
        // AUTH & PROFILE
        case 'login': auth_login($pdo, $input); break;
        case 'register': auth_register($pdo, $input); break;
        case 'heartbeat': auth_heartbeat($pdo, $input); break;
        case 'get_user': auth_get_user($pdo, $input['userId']); break;
        case 'get_all_users': auth_get_all_users($pdo); break;
        case 'update_user_profile': auth_update_user($pdo, $input); break;

        // VIDEOS
        case 'get_videos': video_get_all($pdo); break;
        case 'get_video': video_get_one($pdo, $input['id']); break;
        case 'upload_video': video_upload($pdo, $_POST, $_FILES); break;
        case 'purchase_video': interact_purchase($pdo, $input); break;
        case 'has_purchased': interact_has_purchased($pdo, $input['userId'], $input['videoId']); break;
        case 'stream': streamVideo($input['id'], $pdo); break;

        // ECONOMÍA CERRADA (P2P & VIP)
        case 'transfer_balance': interact_transfer_balance($pdo, $input); break;
        case 'purchase_vip_instant': interact_purchase_vip_instant($pdo, $input); break;
        case 'request_balance': admin_add_balance($pdo, $input); break; // Map to direct injection for now
        case 'request_vip': payment_create_link($pdo, $input); break; // FIXED MAPPING
        case 'verify_payment': payment_verify($pdo, $input); break; // NEW MAPPING
        case 'get_user_transactions': interact_get_transactions($pdo, $input['userId']); break;

        // ADMIN
        case 'get_system_settings': admin_get_settings($pdo); break;
        case 'update_system_settings': admin_update_settings($pdo, $input); break;
        case 'get_real_stats': admin_get_real_stats($pdo); break;
        case 'get_local_stats': admin_get_local_stats($pdo); break;
        case 'get_balance_requests': admin_get_balance_requests($pdo); break;
        case 'handle_balance_request': admin_handle_balance_request($pdo, $input); break;
        case 'handle_vip_request': admin_handle_vip_request($pdo, $input); break;

        default: respond(false, null, "Acción desconocida: $action");
    }
} catch (Exception $e) { 
    if (function_exists('write_log')) write_log("ACTION FAILED ($action): " . $e->getMessage(), 'ERROR');
    respond(false, null, $e->getMessage()); 
}
?>