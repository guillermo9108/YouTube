
<?php
ob_start();
ini_set('display_errors', 0);
error_reporting(E_ALL);
set_time_limit(300);

header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Range');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { ob_clean(); http_response_code(200); exit(); }

// Import shared schema
require_once 'functions_schema.php';

// Global Constants
define('UPLOAD_DIR', 'uploads/videos/');
define('THUMB_DIR', 'uploads/thumbnails/');
define('AVATAR_DIR', 'uploads/avatars/');
define('MARKET_DIR', 'uploads/market/');

// Error Handler
register_shutdown_function(function() {
    $error = error_get_last();
    if ($error && ($error['type'] === E_ERROR || $error['type'] === E_PARSE || $error['type'] === E_CORE_ERROR)) {
        ob_clean();
        header('Content-Type: application/json');
        echo json_encode(['success' => false, 'error' => 'Critical PHP Error: ' . $error['message']]);
        exit;
    }
});

// DB Connection
$configFile = 'db_config.json';
if (!file_exists($configFile)) {
    header('Content-Type: application/json');
    echo json_encode(['success'=>false, 'error'=>'Not installed']);
    exit();
}

$db_config = json_decode(file_get_contents($configFile), true);

try {
    $pdo = new PDO("mysql:host={$db_config['host']};port={$db_config['port']};dbname={$db_config['name']}", $db_config['user'], $db_config['password'], [PDO::ATTR_PERSISTENT => true]);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'DB Connection Error: ' . $e->getMessage()]);
    exit();
}

// Load Modules (Converted to .php by build script)
require_once 'functions_utils.php';
require_once 'functions_auth.php';
require_once 'functions_videos.php';
require_once 'functions_interactions.php';
require_once 'functions_market.php';
require_once 'functions_admin.php';

// Request Handling
$action = $_GET['action'] ?? null;
$input = json_decode(file_get_contents('php://input'), true) ?? $_POST;

// Stream is special
if ($action === 'stream') {
    $vid = $_GET['id'] ?? '';
    $stmt = $pdo->prepare("SELECT videoUrl, isLocal FROM videos WHERE id = ?");
    $stmt->execute([$vid]);
    $row = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($row && $row['isLocal']) streamVideo($row['videoUrl'], $pdo);
    else { http_response_code(404); die("Invalid stream target"); }
    exit;
}

try {
    switch ($action) {
        // Auth
        case 'login': auth_login($pdo, $input); break;
        case 'logout': auth_logout($pdo, $input); break;
        case 'heartbeat': auth_heartbeat($pdo, $input); break;
        case 'register': auth_register($pdo, $input); break;
        case 'get_user': auth_get_user($pdo, $_GET['id']); break;
        case 'update_user': auth_update_user($pdo, $input); break;
        case 'update_avatar': auth_update_avatar($pdo, $input); break;
        case 'change_password': auth_change_password($pdo, $input); break;
        case 'get_all_users': auth_get_all_users($pdo); break;

        // Videos
        case 'get_videos': video_get_all($pdo); break;
        case 'get_video': video_get_one($pdo, $_GET['id']); break;
        case 'get_creator_videos': video_get_by_creator($pdo, $_GET['creatorId']); break;
        case 'get_related_videos': video_get_related($pdo, $_GET['id']); break;
        case 'upload_video': video_upload($pdo, $_POST, $_FILES); break;
        case 'delete_video': video_delete($pdo, $input); break;
        case 'upload_avatar': auth_update_avatar($pdo, $input); break;
        case 'repair_thumbnail': video_repair_thumbnail($pdo, $_POST, $_FILES); break;
        case 'server_import_video': video_server_import($pdo, $input); break;
        
        // Scan System
        case 'scan_local_library': video_scan_local($pdo, $input); break;
        case 'scan_local_process_batch': video_scan_process_batch($pdo); break;
        case 'get_scan_status': video_get_scan_status($pdo); break;
        case 'scan_ftp_library': video_scan_ftp($pdo, $input); break;
        
        case 'update_prices_bulk': video_update_prices_bulk($pdo, $input); break;

        // Interactions
        case 'has_purchased': interact_has_purchased($pdo, $_GET['userId'], $_GET['videoId']); break;
        case 'purchase_video': interact_purchase($pdo, $input); break;
        case 'get_user_activity': interact_get_activity($pdo, $_GET['userId']); break;
        case 'get_interaction': interact_get($pdo, $_GET['userId'], $_GET['videoId']); break;
        case 'rate_video': interact_rate($pdo, $input); break;
        case 'mark_watched': interact_mark_watched($pdo, $input); break;
        case 'get_comments': interact_get_comments($pdo, $_GET['videoId']); break;
        case 'add_comment': interact_add_comment($pdo, $input); break;
        case 'toggle_subscribe': interact_toggle_subscribe($pdo, $input); break;
        case 'check_subscription': interact_check_subscription($pdo, $_GET['userId'], $_GET['creatorId']); break;
        case 'get_subscriptions': interact_get_subscriptions($pdo, $_GET['userId']); break;
        case 'get_notifications': interact_get_notifications($pdo, $_GET['userId']); break;
        case 'mark_notification_read': interact_mark_notification_read($pdo, $input); break;
        case 'get_transactions': interact_get_transactions($pdo, $_GET['userId']); break;
        case 'request_balance': user_request_balance($pdo, $input); break;

        // Admin
        case 'admin_add_balance': admin_add_balance($pdo, $input); break;
        case 'admin_get_balance_requests': admin_get_balance_requests($pdo); break;
        case 'admin_handle_balance_request': admin_handle_balance_request($pdo, $input); break;
        case 'admin_cleanup_videos': admin_cleanup_videos($pdo); break;
        case 'admin_repair_db': admin_repair_db($pdo); break;
        case 'admin_smart_cleaner_preview': admin_smart_cleaner_preview($pdo, $input); break;
        case 'admin_smart_cleaner_execute': admin_smart_cleaner_execute($pdo, $input); break;
        case 'get_requests': admin_get_requests($pdo, $_GET['status'] ?? ''); break;
        case 'request_content': admin_request_content($pdo, $input); break;
        case 'delete_request': admin_delete_request($pdo, $input); break;
        case 'process_queue': admin_process_queue($pdo); break;
        case 'get_system_settings': admin_get_settings($pdo); break;
        case 'update_system_settings': admin_update_settings($pdo, $input); break;
        case 'search_external': admin_search_external($pdo, $input); break;

        // Market
        case 'get_marketplace_items': market_get_items($pdo); break;
        case 'admin_get_marketplace_items': market_admin_get_items($pdo); break;
        case 'admin_delete_listing': market_delete_listing($pdo, $input); break;
        case 'get_marketplace_item': market_get_item($pdo, $_GET['id']); break;
        case 'create_listing': market_create_listing($pdo, $_POST, $_FILES); break;
        case 'edit_listing': market_edit_listing($pdo, $input); break;
        case 'checkout_cart': market_checkout($pdo, $input); break;
        case 'add_review': market_add_review($pdo, $input); break;
        case 'get_reviews': market_get_reviews($pdo, $_GET['itemId']); break;
        
        // New Sales Management
        case 'get_sales': market_get_sales($pdo, $_GET['userId']); break;
        case 'update_order_status': market_update_order_status($pdo, $input); break;

        default:
            respond(false, null, 'Invalid action');
    }
} catch (Exception $e) {
    respond(false, null, 'Error: ' . $e->getMessage());
}
?>
