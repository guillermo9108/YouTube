<?php
/**
 * StreamPay - Core Controller V5 (Diagnostic Ready)
 * Blindaje total y telemetría de errores para depuración sin acceso a archivos.
 */

// 1. Silenciar salida estándar de errores totalmente
ini_set('display_errors', 0);
ini_set('log_errors', 1);
error_reporting(E_ALL); // Capturamos TODO internamente

// 2. Control total del búfer
if (ob_get_level() == 0) ob_start();

// 3. Manejador de errores no-fatales (Warnings, Notices)
set_error_handler(function($errno, $errstr, $errfile, $errline) {
    if (!(error_reporting() & $errno)) return false;
    // En lugar de imprimir el warning, lo guardamos para el JSON final
    $GLOBALS['php_warnings'][] = "[$errno] $errstr en $errfile:$errline";
    return true;
});

// 4. Manejador de errores fatales
register_shutdown_function(function() {
    $error = error_get_last();
    if ($error && in_array($error['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR])) {
        while (ob_get_level() > 0) ob_end_clean();
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode([
            'success' => false, 
            'data' => null, 
            'error' => 'CRASH FATAL PHP: ' . $error['message'] . ' en ' . $error['file'] . ':' . $error['line'],
            'diagnostic' => true
        ]);
        exit;
    }
});

/**
 * Función de respuesta unificada
 */
function respond($success, $data = null, $error = null) {
    while (ob_get_level() > 0) ob_end_clean();
    
    header('Content-Type: application/json; charset=utf-8');
    $res = [
        'success' => $success, 
        'data' => $data, 
        'error' => $error
    ];
    
    // Si hubo warnings durante la ejecución, los incluimos para diagnóstico
    if (!empty($GLOBALS['php_warnings'])) {
        $res['warnings'] = $GLOBALS['php_warnings'];
    }
    
    echo json_encode($res, JSON_UNESCAPED_UNICODE | JSON_PARTIAL_OUTPUT_ON_ERROR);
    exit();
}

header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { 
    while (ob_get_level() > 0) ob_end_clean();
    exit(); 
}

define('AVATAR_DIR', 'uploads/avatars/');
define('MARKET_DIR', 'uploads/market/');

$action = $_GET['action'] ?? null;
$input = json_decode(file_get_contents('php://input'), true) ?? $_POST;
$configFile = 'db_config.json';

// Cargar librerías con silenciador de inclusión
$required_files = ['functions_schema.php', 'functions_utils.php', 'functions_auth.php', 'functions_videos.php', 'functions_interactions.php', 'functions_market.php', 'functions_admin.php', 'functions_payment.php'];
foreach ($required_files as $file) { 
    if (file_exists($file)) { @require_once $file; }
}

if ($action === 'check_installation') {
    $installed = file_exists($configFile);
    respond(true, ['status' => $installed ? 'installed' : 'not_installed']);
}

if (!file_exists($configFile)) respond(false, null, 'No instalado');
$db_config = json_decode(file_get_contents($configFile), true);

try {
    $pdo = new PDO("mysql:host={$db_config['host']};port={$db_config['port']};dbname={$db_config['name']};charset=utf8mb4", $db_config['user'], $db_config['password'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
} catch (PDOException $e) { 
    respond(false, null, 'Error DB: ' . $e->getMessage()); 
}

// Ejecutar acción
try {
    switch ($action) {
        case 'login': auth_login($pdo, $input); break;
        case 'get_videos': video_get_all($pdo); break;
        case 'get_system_settings': admin_get_settings($pdo); break;
        case 'admin_get_local_stats': admin_get_local_stats($pdo); break;
        case 'admin_transcode_batch': admin_transcode_batch($pdo); break;
        case 'admin_scan_incompatible': admin_scan_incompatible($pdo, $input); break;
        case 'admin_smart_cleaner_preview': admin_smart_cleaner_preview($pdo, $input); break;
        case 'admin_smart_cleaner_execute': admin_smart_cleaner_execute($pdo, $input); break;
        case 'admin_organize_paquete': admin_organize_paquete($pdo, $input); break;
        case 'admin_cleanup_system_files': admin_cleanup_system_files($pdo); break;
        case 'admin_repair_db': admin_repair_db($pdo); break;
        case 'stream': 
            $stmt = $pdo->prepare("SELECT videoUrl FROM videos WHERE id = ?");
            $stmt->execute([$_GET['id']]);
            $url = $stmt->fetchColumn();
            if ($url) streamVideo($url, $pdo);
            break;
        // Fallback para cualquier otra acción definida en las librerías
        default: 
            $fn = "action_$action";
            if (function_exists($fn)) { $fn($pdo, $input); }
            else { respond(false, null, "Acción desconocida: $action"); }
    }
} catch (Exception $e) { 
    respond(false, null, $e->getMessage()); 
}
?>