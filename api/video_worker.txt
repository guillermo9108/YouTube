<?php
/**
 * StreamPay - Server-Side Video Worker V1.0
 * Este script procesa la cola de videos PENDING de forma automática.
 * Ejecución recomendada: php video_worker.php
 */

// Aumentar límites para procesos largos
set_time_limit(0);
ini_set('memory_limit', '512M');

require_once 'functions_utils.php';

// 1. Cargar Configuración de BD
$configFile = 'db_config.json';
if (!file_exists($configFile)) {
    die("Error: Sistema no instalado (Falta db_config.json)\n");
}
$config = json_decode(file_get_contents($configFile), true);

try {
    $dsn = "mysql:host={$config['host']};port={$config['port']};dbname={$config['name']};charset=utf8mb4";
    $pdo = new PDO($dsn, $config['user'], $config['password'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
} catch (PDOException $e) {
    die("Error de conexión BD: " . $e->getMessage() . "\n");
}

// 2. Obtener Rutas de Herramientas del Sistema
$stmtS = $pdo->query("SELECT ffmpegPath, categories FROM system_settings WHERE id = 1");
$settings = $stmtS->fetch();
$ffmpeg = $settings['ffmpegPath'] ?: 'ffmpeg';
$ffprobe = str_replace('ffmpeg', 'ffprobe', $ffmpeg); // Asumimos que están en la misma carpeta

// 3. Buscar un video PENDING que no esté bloqueado
$now = time();
$timeout = $now - 600; // 10 minutos de gracia para bloqueos viejos

$stmt = $pdo->prepare("SELECT * FROM videos WHERE category = 'PENDING' AND locked_at < ? ORDER BY createdAt ASC LIMIT 1");
$stmt->execute([$timeout]);
$video = $stmt->fetch();

if (!$video) {
    echo "No hay videos pendientes de procesar.\n";
    exit;
}

// 4. Bloquear registro para este proceso
$pdo->prepare("UPDATE videos SET locked_at = ? WHERE id = ?")->execute([$now, $video['id']]);

echo "Procesando: {$video['title']} (ID: {$video['id']})\n";

$realPath = resolve_video_path($video['videoUrl']);
if (!$realPath || !file_exists($realPath)) {
    echo "Error: Archivo no encontrado en disco: {$video['videoUrl']}\n";
    $pdo->prepare("UPDATE videos SET category = 'FAILED_METADATA', reason = 'Archivo no encontrado' WHERE id = ?")->execute([$video['id']]);
    exit;
}

// 5. Determinar si es Audio
$ext = strtolower(pathinfo($realPath, PATHINFO_EXTENSION));
$isAudio = in_array($ext, ['mp3', 'wav', 'aac', 'm4a', 'flac']) || (isset($video['is_audio']) && $video['is_audio']);

// 6. Obtener Duración vía FFPROBE
$duration = 0;
$probeCmd = "$ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 " . escapeshellarg($realPath);
$output = shell_exec($probeCmd);
$duration = floor(floatval(trim($output)));

if ($duration <= 0) {
    echo "Error: No se pudo obtener la duración.\n";
    $pdo->prepare("UPDATE videos SET processing_attempts = processing_attempts + 1, locked_at = 0 WHERE id = ?")->execute([$video['id']]);
    exit;
}

$thumbPath = null;
$finalCategory = 'PROCESSING'; // Listo para el Paso 3 (Organización IA)

// 7. Extraer Miniatura (Solo para Videos)
if (!$isAudio) {
    $thumbFile = 'uploads/thumbnails/' . $video['id'] . '.jpg';
    $fullThumbPath = __DIR__ . '/' . $thumbFile;
    
    // Capturar frame en el segundo 2
    $captureTime = ($duration > 5) ? "00:00:02" : "00:00:00.5";
    $ffmpegCmd = "$ffmpeg -y -ss $captureTime -i " . escapeshellarg($realPath) . " -frames:v 1 -q:v 4 " . escapeshellarg($fullThumbPath) . " 2>&1";
    
    exec($ffmpegCmd, $outputLog, $returnVar);
    
    if ($returnVar === 0 && file_exists($fullThumbPath)) {
        $thumbPath = 'api/' . $thumbFile;
        echo "Miniatura extraída con éxito.\n";
    } else {
        echo "Advertencia: Falló extracción de miniatura de video.\n";
    }
} else {
    // Es Audio: Usar imagen por defecto
    $thumbPath = 'api/uploads/thumbnails/defaultaudio.jpg';
    echo "Archivo detectado como Audio. Asignando imagen por defecto.\n";
}

// 8. Actualizar Base de Datos
$fields = ["duration = ?", "category = 'PROCESSING'", "locked_at = 0", "processing_attempts = 0"];
$params = [$duration];

if ($thumbPath) {
    $fields[] = "thumbnailUrl = ?";
    $params[] = $thumbPath;
}

$params[] = $video['id'];
$sql = "UPDATE videos SET " . implode(', ', $fields) . " WHERE id = ?";
$pdo->prepare($sql)->execute($params);

// 9. Auto-Organización (Paso 3 Integrado)
require_once 'functions_videos.php';
$settingsArr = $pdo->query("SELECT * FROM system_settings WHERE id = 1")->fetch();
video_organize_single($pdo, $video['id'], $settingsArr);

echo "Completado: {$video['title']}. Duración: {$duration}s. Estado: Publicado.\n";
?>