<?php
function interact_has_purchased($pdo, $userId, $videoId) {
    $stmt = $pdo->prepare("
        SELECT v.creatorId, u.role as creatorRole, 
               (SELECT role FROM users WHERE id = ?) as userRole,
               (SELECT vipExpiry FROM users WHERE id = ?) as vipExpiry
        FROM videos v 
        LEFT JOIN users u ON v.creatorId = u.id 
        WHERE v.id = ?
    ");
    $stmt->execute([$userId, $userId, $videoId]);
    $data = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($data) {
        if ($data['userRole'] === 'ADMIN') { respond(true, ['hasPurchased' => true]); return; }
        if ($data['creatorId'] === $userId) { respond(true, ['hasPurchased' => true]); return; }
        if ($data['vipExpiry'] && intval($data['vipExpiry']) > time()) {
            if ($data['creatorRole'] === 'ADMIN') { respond(true, ['hasPurchased' => true]); return; }
        }
    }
    $stmt = $pdo->prepare("SELECT COUNT(*) FROM transactions WHERE buyerId = ? AND videoId = ? AND type = 'PURCHASE'");
    $stmt->execute([$userId, $videoId]);
    respond(true, ['hasPurchased' => $stmt->fetchColumn() > 0]);
}

function interact_transfer_balance($pdo, $input) {
    $senderId = $input['userId'];
    $targetUsername = trim($input['targetUsername']);
    $amount = floatval($input['amount']);
    if ($amount <= 0) respond(false, null, 'Monto invÃ¡lido');
    $pdo->beginTransaction();
    try {
        $stmt = $pdo->prepare("SELECT id, username FROM users WHERE username = ?");
        $stmt->execute([$targetUsername]);
        $target = $stmt->fetch(PDO::FETCH_ASSOC);
        if (!$target) throw new Exception("Receptor no encontrado");
        if ($target['id'] === $senderId) throw new Exception("No puedes enviarte a ti mismo");
        $feePct = $pdo->query("SELECT transferFee FROM system_settings LIMIT 1")->fetchColumn() ?: 5;
        $feeAmount = $amount * ($feePct / 100);
        $netAmount = $amount - $feeAmount;
        $stmt = $pdo->prepare("SELECT balance FROM users WHERE id = ? FOR UPDATE");
        $stmt->execute([$senderId]);
        if ($stmt->fetchColumn() < $amount) throw new Exception("Saldo insuficiente");
        $pdo->prepare("UPDATE users SET balance = balance - ? WHERE id = ?")->execute([$amount, $senderId]);
        $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$netAmount, $target['id']]);
        $adminId = $pdo->query("SELECT id FROM users WHERE role = 'ADMIN' LIMIT 1")->fetchColumn();
        if ($adminId) { $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$feeAmount, $adminId]); }
        $pdo->prepare("INSERT INTO transactions (id, buyerId, targetId, amount, adminFee, timestamp, type) VALUES (?, ?, ?, ?, ?, ?, 'TRANSFER_SENT')")
            ->execute([uniqid('tr_'), $senderId, $target['id'], $amount, $feeAmount, time()]);
        $pdo->prepare("INSERT INTO transactions (id, buyerId, targetId, amount, timestamp, type) VALUES (?, ?, ?, ?, ?, 'TRANSFER_RECV')")
            ->execute([uniqid('tr_'), $target['id'], $senderId, $netAmount, time()]);
        $pdo->commit(); respond(true, ['netAmount' => $netAmount, 'fee' => $feeAmount]);
    } catch (Exception $e) { $pdo->rollBack(); respond(false, null, $e->getMessage()); }
}

function interact_get_transactions($pdo, $userId) {
    // Consulta mejorada para manejar transferencias y compras con nombres de involucrados
    $stmt = $pdo->prepare("
        SELECT t.*, 
               u1.username as targetName, 
               u2.username as buyerName,
               v.title as videoTitle
        FROM transactions t 
        LEFT JOIN users u1 ON t.targetId = u1.id 
        LEFT JOIN users u2 ON t.buyerId = u2.id
        LEFT JOIN videos v ON t.videoId = v.id
        WHERE t.buyerId = ? OR t.creatorId = ? OR t.targetId = ? 
        ORDER BY t.timestamp DESC
    ");
    $stmt->execute([$userId, $userId, $userId]);
    respond(true, $stmt->fetchAll(PDO::FETCH_ASSOC));
}

function interact_get_subscriptions($pdo, $uid) {
    $stmt = $pdo->prepare("SELECT creatorId FROM subscriptions WHERE subscriberId = ?");
    $stmt->execute([$uid]);
    respond(true, $stmt->fetchAll(PDO::FETCH_COLUMN));
}

function interact_rate($pdo, $input) {
    $userId = $input['userId']; $videoId = $input['videoId']; $rating = $input['type'] ?? 'like';
    $stmt = $pdo->prepare("SELECT * FROM interactions WHERE userId = ? AND videoId = ?");
    $stmt->execute([$userId, $videoId]); $current = $stmt->fetch();
    $liked = $current ? $current['liked'] : 0; $disliked = $current ? $current['disliked'] : 0;
    if ($rating === 'like') { $liked = !$liked; if ($liked) $disliked = 0; } else { $disliked = !$disliked; if ($disliked) $liked = 0; }
    $pdo->prepare("INSERT INTO interactions (userId, videoId, liked, disliked) VALUES (?, ?, ?, ?) ON DUPLICATE KEY UPDATE liked = VALUES(liked), disliked = VALUES(disliked)")
        ->execute([$userId, $videoId, $liked ? 1 : 0, $disliked ? 1 : 0]);
    respond(true, ['liked' => (bool)$liked, 'disliked' => (bool)$disliked]);
}

function interact_mark_watched($pdo, $input) {
    $pdo->prepare("INSERT INTO interactions (userId, videoId, isWatched) VALUES (?, ?, 1) ON DUPLICATE KEY UPDATE isWatched = 1")
        ->execute([$input['userId'], $input['videoId']]);
    $pdo->prepare("UPDATE videos SET views = views + 1 WHERE id = ?")->execute([$input['videoId']]);
    respond(true);
}

function interact_get_comments($pdo, $videoId) {
    $stmt = $pdo->prepare("SELECT c.*, u.username, u.avatarUrl as userAvatarUrl FROM comments c JOIN users u ON c.userId = u.id WHERE c.videoId = ? ORDER BY c.timestamp DESC");
    $stmt->execute([$videoId]);
    $comments = $stmt->fetchAll(PDO::FETCH_ASSOC);
    foreach ($comments as &$c) { $c['userAvatarUrl'] = fix_url($c['userAvatarUrl']); }
    respond(true, $comments);
}

function interact_add_comment($pdo, $input) {
    $cid = uniqid('c_');
    $pdo->prepare("INSERT INTO comments (id, videoId, userId, text, timestamp) VALUES (?, ?, ?, ?, ?)")
        ->execute([$cid, $input['videoId'], $input['userId'], $input['text'], time()]);
    $stmt = $pdo->prepare("SELECT c.*, u.username, u.avatarUrl as userAvatarUrl FROM comments c JOIN users u ON c.userId = u.id WHERE c.id = ?");
    $stmt->execute([$cid]); $comment = $stmt->fetch();
    if($comment) $comment['userAvatarUrl'] = fix_url($comment['userAvatarUrl']);
    respond(true, $comment);
}

function interact_toggle_subscribe($pdo, $input) {
    $sub = $input['userId']; $creator = $input['creatorId'];
    $check = $pdo->prepare("SELECT COUNT(*) FROM subscriptions WHERE subscriberId = ? AND creatorId = ?");
    $check->execute([$sub, $creator]);
    if ($check->fetchColumn() > 0) {
        $pdo->prepare("DELETE FROM subscriptions WHERE subscriberId = ? AND creatorId = ?")->execute([$sub, $creator]);
        respond(true, ['isSubscribed' => false]);
    } else {
        $pdo->prepare("INSERT INTO subscriptions (subscriberId, creatorId, createdAt) VALUES (?, ?, ?)")->execute([$sub, $creator, time()]);
        respond(true, ['isSubscribed' => true]);
    }
}

function interact_check_subscription($pdo, $uid, $cid) {
    $stmt = $pdo->prepare("SELECT COUNT(*) FROM subscriptions WHERE subscriberId = ? AND creatorId = ?");
    $stmt->execute([$uid, $cid]);
    respond(true, ['isSubscribed' => $stmt->fetchColumn() > 0]);
}

function interact_get_notifications($pdo, $uid) {
    $stmt = $pdo->prepare("SELECT * FROM notifications WHERE userId = ? ORDER BY timestamp DESC LIMIT 30");
    $stmt->execute([$uid]); $list = $stmt->fetchAll(PDO::FETCH_ASSOC);
    foreach($list as &$n) {
        $n['avatarUrl'] = fix_url($n['avatarUrl'] ?? null);
        $n['metadata'] = json_decode($n['metadata'] ?? 'null', true);
    }
    respond(true, $list);
}

function interact_mark_notification_read($pdo, $input) {
    $pdo->prepare("UPDATE notifications SET isRead = 1 WHERE id = ?")->execute([$input['id']]);
    respond(true);
}

function interact_get_activity($pdo, $userId) {
    $liked = $pdo->prepare("SELECT videoId FROM interactions WHERE userId = ? AND liked = 1");
    $liked->execute([$userId]);
    $watched = $pdo->prepare("SELECT videoId FROM interactions WHERE userId = ? AND isWatched = 1");
    $watched->execute([$userId]);
    respond(true, ['liked' => $liked->fetchAll(PDO::FETCH_COLUMN), 'watched' => $watched->fetchAll(PDO::FETCH_COLUMN)]);
}

function interact_get($pdo, $userId, $videoId) {
    $stmt = $pdo->prepare("SELECT * FROM interactions WHERE userId = ? AND videoId = ?");
    $stmt->execute([$userId, $videoId]);
    $res = $stmt->fetch(PDO::FETCH_ASSOC);
    respond(true, $res ?: ['liked'=>false, 'disliked'=>false, 'isWatched'=>false]);
}
?>