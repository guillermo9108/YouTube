<?php
function interact_has_purchased($pdo, $userId, $videoId) {
    // 1. Check if user is ADMIN. Admins have global access.
    $stmt = $pdo->prepare("SELECT role FROM users WHERE id = ?");
    $stmt->execute([$userId]);
    $role = $stmt->fetchColumn();
    
    if ($role === 'ADMIN') {
        respond(true, ['hasPurchased' => true]);
        return;
    }

    // 2. Check if owned or purchased
    $stmt = $pdo->prepare("SELECT COUNT(*) FROM transactions WHERE buyerId = ? AND videoId = ? AND type = 'PURCHASE'");
    $stmt->execute([$userId, $videoId]);
    respond(true, ['hasPurchased' => $stmt->fetchColumn() > 0]);
}

function interact_purchase($pdo, $input) {
    $buyerId = $input['userId'];
    $videoId = $input['videoId'];

    $pdo->beginTransaction();
    try {
        // Get Video Price & Creator
        $stmt = $pdo->prepare("SELECT price, creatorId, title FROM videos WHERE id = ?");
        $stmt->execute([$videoId]);
        $video = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$video) throw new Exception("Video not found");

        // Prevent self-purchase
        if ($buyerId === $video['creatorId']) throw new Exception("Cannot purchase your own video");

        // Check Balance
        $stmt = $pdo->prepare("SELECT balance FROM users WHERE id = ? FOR UPDATE");
        $stmt->execute([$buyerId]);
        $balance = $stmt->fetchColumn();

        if ($balance < $video['price']) throw new Exception("Insufficient funds");

        // Deduct from Buyer
        $pdo->prepare("UPDATE users SET balance = balance - ? WHERE id = ?")->execute([$video['price'], $buyerId]);

        // Add to Creator
        $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$video['price'], $video['creatorId']]);

        // Record Transaction
        $tid = uniqid('tx_');
        $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, ?, ?, ?, ?, 'PURCHASE')")
            ->execute([$tid, $buyerId, $video['creatorId'], $videoId, $video['price'], time()]);
            
        // Notify Creator
        $nid = uniqid('n_');
        $notifText = "Sold video '{$video['title']}' for {$video['price']} Saldo";
        $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SALE', ?, '/profile', 0, ?)")
            ->execute([$nid, $video['creatorId'], $notifText, time()]);

        $pdo->commit();
        respond(true);
    } catch (Exception $e) {
        $pdo->rollBack();
        respond(false, null, $e->getMessage());
    }
}

function interact_get_activity($pdo, $userId) {
    $liked = $pdo->prepare("SELECT videoId FROM interactions WHERE userId = ? AND liked = 1");
    $liked->execute([$userId]);
    
    $watched = $pdo->prepare("SELECT videoId FROM interactions WHERE userId = ? AND isWatched = 1");
    $watched->execute([$userId]);
    
    respond(true, [
        'liked' => $liked->fetchAll(PDO::FETCH_COLUMN),
        'watched' => $watched->fetchAll(PDO::FETCH_COLUMN)
    ]);
}

function interact_get($pdo, $userId, $videoId) {
    $stmt = $pdo->prepare("SELECT * FROM interactions WHERE userId = ? AND videoId = ?");
    $stmt->execute([$userId, $videoId]);
    $res = $stmt->fetch(PDO::FETCH_ASSOC);
    respond(true, $res ?: ['liked'=>false, 'disliked'=>false, 'isWatched'=>false]);
}

function interact_rate($pdo, $input) {
    $userId = $input['userId'];
    $videoId = $input['videoId'];
    $rating = $input['rating']; // 'like' or 'dislike'

    // Get current state
    $stmt = $pdo->prepare("SELECT * FROM interactions WHERE userId = ? AND videoId = ?");
    $stmt->execute([$userId, $videoId]);
    $current = $stmt->fetch(PDO::FETCH_ASSOC);

    $liked = $current ? $current['liked'] : 0;
    $disliked = $current ? $current['disliked'] : 0;
    $watched = $current ? $current['isWatched'] : 0;

    // Toggle Logic
    if ($rating === 'like') {
        $liked = !$liked;
        if ($liked) $disliked = false;
    } else {
        $disliked = !$disliked;
        if ($disliked) $liked = false;
    }

    // Upsert Interaction
    $sql = "INSERT INTO interactions (userId, videoId, liked, disliked, isWatched) VALUES (?, ?, ?, ?, ?) 
            ON DUPLICATE KEY UPDATE liked = VALUES(liked), disliked = VALUES(disliked)";
    $pdo->prepare($sql)->execute([$userId, $videoId, $liked ? 1 : 0, $disliked ? 1 : 0, $watched]);

    // Recalculate Video Totals
    $countLikes = $pdo->prepare("SELECT COUNT(*) FROM interactions WHERE videoId = ? AND liked = 1");
    $countLikes->execute([$videoId]);
    $newLikes = $countLikes->fetchColumn();

    $countDislikes = $pdo->prepare("SELECT COUNT(*) FROM interactions WHERE videoId = ? AND disliked = 1");
    $countDislikes->execute([$videoId]);
    $newDislikes = $countDislikes->fetchColumn();

    $pdo->prepare("UPDATE videos SET likes = ?, dislikes = ? WHERE id = ?")->execute([$newLikes, $newDislikes, $videoId]);

    respond(true, [
        'liked' => (bool)$liked,
        'disliked' => (bool)$disliked,
        'newLikeCount' => $newLikes,
        'newDislikeCount' => $newDislikes
    ]);
}

function interact_mark_watched($pdo, $input) {
    $sql = "INSERT INTO interactions (userId, videoId, isWatched) VALUES (?, ?, 1) ON DUPLICATE KEY UPDATE isWatched = 1";
    $pdo->prepare($sql)->execute([$input['userId'], $input['videoId']]);
    
    // Increment View Count (Unique user view logic could be here, but simpler is +1 per cached hit in frontend)
    respond(true);
}

function interact_get_comments($pdo, $videoId) {
    $stmt = $pdo->prepare("
        SELECT c.*, u.username, u.avatarUrl as userAvatarUrl 
        FROM comments c 
        JOIN users u ON c.userId = u.id 
        WHERE c.videoId = ? 
        ORDER BY c.timestamp DESC
    ");
    $stmt->execute([$videoId]);
    respond(true, $stmt->fetchAll(PDO::FETCH_ASSOC));
}

function interact_add_comment($pdo, $input) {
    $cid = uniqid('c_');
    $stmt = $pdo->prepare("INSERT INTO comments (id, videoId, userId, text, timestamp) VALUES (?, ?, ?, ?, ?)");
    $stmt->execute([$cid, $input['videoId'], $input['userId'], $input['text'], time()]);
    
    // Return complete object for UI
    $stmt = $pdo->prepare("SELECT c.*, u.username, u.avatarUrl as userAvatarUrl FROM comments c JOIN users u ON c.userId = u.id WHERE c.id = ?");
    $stmt->execute([$cid]);
    respond(true, $stmt->fetch(PDO::FETCH_ASSOC));
}

function interact_toggle_subscribe($pdo, $input) {
    $sub = $input['userId'];
    $creator = $input['creatorId'];
    
    $check = $pdo->prepare("SELECT COUNT(*) FROM subscriptions WHERE subscriberId = ? AND creatorId = ?");
    $check->execute([$sub, $creator]);
    
    if ($check->fetchColumn() > 0) {
        $pdo->prepare("DELETE FROM subscriptions WHERE subscriberId = ? AND creatorId = ?")->execute([$sub, $creator]);
        respond(true, ['isSubscribed' => false]);
    } else {
        $pdo->prepare("INSERT INTO subscriptions (subscriberId, creatorId, createdAt) VALUES (?, ?, ?)")->execute([$sub, $creator, time()]);
        respond(true, ['isSubscribed' => true]);
    }
}

function interact_check_subscription($pdo, $uid, $cid) {
    $stmt = $pdo->prepare("SELECT COUNT(*) FROM subscriptions WHERE subscriberId = ? AND creatorId = ?");
    $stmt->execute([$uid, $cid]);
    respond(true, ['isSubscribed' => $stmt->fetchColumn() > 0]);
}

function interact_get_subscriptions($pdo, $uid) {
    $stmt = $pdo->prepare("SELECT creatorId FROM subscriptions WHERE subscriberId = ?");
    $stmt->execute([$uid]);
    respond(true, $stmt->fetchAll(PDO::FETCH_COLUMN));
}

function interact_get_notifications($pdo, $uid) {
    $stmt = $pdo->prepare("SELECT * FROM notifications WHERE userId = ? ORDER BY timestamp DESC LIMIT 20");
    $stmt->execute([$uid]);
    respond(true, $stmt->fetchAll(PDO::FETCH_ASSOC));
}

function interact_mark_notification_read($pdo, $input) {
    $pdo->prepare("UPDATE notifications SET isRead = 1 WHERE id = ?")->execute([$input['notifId']]);
    respond(true);
}

function interact_get_transactions($pdo, $userId) {
    $stmt = $pdo->prepare("SELECT * FROM transactions WHERE buyerId = ? OR creatorId = ? ORDER BY timestamp DESC");
    $stmt->execute([$userId, $userId]);
    respond(true, $stmt->fetchAll(PDO::FETCH_ASSOC));
}
?>