<?php

/**
 * Sistema de Logs Centralizado
 */
function write_log($message, $level = 'INFO') {
    $logFile = __DIR__ . '/debug_log.txt';
    $timestamp = date('Y-m-d H:i:s');
    $formattedMessage = "[$timestamp] [$level] $message" . PHP_EOL;
    @file_put_contents($logFile, $formattedMessage, FILE_APPEND);
}

function fix_url($url) {
    if (!empty($url) && strpos($url, 'uploads/') === 0) { return 'api/' . $url; }
    return $url;
}

function resolve_video_path($pathOrUrl) {
    if (!$pathOrUrl) return false;
    if (file_exists($pathOrUrl)) return realpath($pathOrUrl);
    $cleanPath = $pathOrUrl;
    if (strpos($cleanPath, 'api/') === 0) { $cleanPath = substr($cleanPath, 4); }
    if (file_exists($cleanPath)) return realpath($cleanPath);
    return false;
}

function getPriceForCategory($cat, $settings) {
    $categories = is_array($settings['customCategories']) ? $settings['customCategories'] : json_decode($settings['customCategories'] ?? '[]', true);
    
    // Función para buscar precio en el árbol
    $findPrice = function($nodes, $targetId) use (&$findPrice) {
        if (!is_array($nodes)) return null;
        foreach($nodes as $node) {
            if (!is_array($node)) continue;
            // Si el nombre de la categoría actual está contenido en la ruta jerárquica final
            if (isset($node['name']) && stripos($targetId, $node['name']) !== false) {
                 // Si hay subcategoría dinámica, intentamos devolver el precio del nodo más profundo posible
                 $subPrice = null;
                 if (!empty($node['children'])) {
                     $subPrice = $findPrice($node['children'], $targetId);
                 }
                 return ($subPrice !== null) ? $subPrice : (isset($node['price']) ? floatval($node['price']) : null);
            }
        }
        return null;
    };

    $specificPrice = $findPrice($categories, $cat);
    if ($specificPrice !== null) return floatval($specificPrice);

    $prices = is_array($settings['categoryPrices']) ? $settings['categoryPrices'] : json_decode($settings['categoryPrices'] ?? '{}', true);
    return isset($prices[$cat]) ? floatval($prices[$cat]) : 1.00; 
}

/**
 * Motor de Inteligencia Jerárquica V3 - Agrupación por Carpeta Padre
 */
function smartParseFilename($fullPath, $existingCategory = null, $categoriesConfig = []) {
    $fullPathNormalized = str_replace('\\', '/', $fullPath);
    $filename = pathinfo($fullPathNormalized, PATHINFO_FILENAME);
    $dirPath = dirname($fullPathNormalized);
    
    // 1. Limpieza de nombre de archivo (Basura de trackers)
    $junk = ['/\b(2160p|1080p|720p|480p|4k|8k|hd|sd)\b/i', '/\b(x264|x265|h264|h265|hevc)\b/i', '/\b(aac|ac3|dts|mp3|5\.1|7\.1)\b/i', '/\b(bluray|web-dl|webrip|hdrip)\b/i', '/www\.[a-z0-9-]+\.[a-z]+/i'];
    $cleanName = str_replace(['.', '_', '-', '[', ']', '(', ')'], ' ', $filename);
    foreach ($junk as $p) { $cleanName = preg_replace($p, '', $cleanName); }
    $cleanName = trim(preg_replace('/\s+/', ' ', $cleanName));

    // 2. Análisis Jerárquico de Carpetas
    $pathParts = explode('/', $dirPath);
    $detectedBreadcrumb = [];
    $currentNodeLevel = is_array($categoriesConfig) ? $categoriesConfig : [];
    $matchedManual = false;
    $manualMatches = [];

    foreach ($pathParts as $part) {
        $partUpper = strtoupper(trim($part));
        if (empty($partUpper) || in_array($partUpper, ['VAR', 'WWW', 'HTML', 'API', 'UPLOADS', 'VIDEOS', 'VOLUME1', 'VOLUME2', 'DATA'])) continue;

        $matchNode = null;
        if (is_array($currentNodeLevel)) {
            foreach ($currentNodeLevel as $node) {
                if (!is_array($node)) continue;
                $patterns = array_map('strtoupper', $node['folderPatterns'] ?? []);
                if ((isset($node['id']) && $node['id'] === $partUpper) || in_array($partUpper, $patterns)) {
                    $matchNode = $node;
                    break;
                }
            }
        }

        if ($matchNode) {
            $name = $matchNode['name'] ?? $part;
            $detectedBreadcrumb[] = $name;
            $manualMatches[] = strtoupper($name);
            $currentNodeLevel = is_array($matchNode['children'] ?? null) ? $matchNode['children'] : [];
            $matchedManual = true;
        } else if ($matchedManual) {
            // Si ya estamos dentro de una categoría detectada, las carpetas siguientes son subcategorías dinámicas
            // Evitamos duplicar nombres que ya están en el breadcrumb
            if (!in_array($partUpper, $manualMatches)) {
                $detectedBreadcrumb[] = ucwords(strtolower($part));
            }
        }
    }

    // 3. Si no hay ruta detectada, probamos por nombre de archivo
    if (empty($detectedBreadcrumb) && is_array($categoriesConfig)) {
        foreach ($categoriesConfig as $node) {
            if (!is_array($node)) continue;
            foreach ($node['namePatterns'] as $p) {
                if (stripos($filename, $p) !== false) {
                    $detectedBreadcrumb[] = $node['name'];
                    break 2;
                }
            }
        }
    }

    // 4. Limpieza final: El título del video no debe contener las categorías padre si el usuario lo desea
    // Pero por ahora solo formateamos el breadcrumb
    $finalCategory = empty($detectedBreadcrumb) ? 'GENERAL' : implode(' / ', $detectedBreadcrumb);

    return [
        'title' => ucwords(strtolower($cleanName)), 
        'category' => $finalCategory
    ];
}
?>