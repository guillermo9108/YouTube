
<?php
function admin_add_balance($pdo, $input) {
    $adminId = $input['adminId'];
    // Verify admin
    $stmt = $pdo->prepare("SELECT role FROM users WHERE id = ?");
    $stmt->execute([$adminId]);
    if ($stmt->fetchColumn() !== 'ADMIN') respond(false, null, 'Unauthorized');

    $target = $input['targetUserId'];
    $amount = $input['amount'];

    $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$amount, $target]);
    
    // Log deposit
    $tid = uniqid('tx_dep_');
    $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, NULL, NULL, ?, ?, 'DEPOSIT')")
        ->execute([$tid, $target, $amount, time()]);
        
    respond(true);
}

// User Action: Request Balance
function user_request_balance($pdo, $input) {
    $id = uniqid('br_');
    $userId = $input['userId'];
    $amount = $input['amount'];
    
    $pdo->prepare("INSERT INTO balance_requests (id, userId, amount, status, createdAt) VALUES (?, ?, ?, 'PENDING', ?)")
        ->execute([$id, $userId, $amount, time()]);
        
    respond(true);
}

// Admin Action: Get Requests
function admin_get_balance_requests($pdo) {
    $stmt = $pdo->query("SELECT br.*, u.username FROM balance_requests br LEFT JOIN users u ON br.userId = u.id WHERE br.status = 'PENDING' ORDER BY br.createdAt ASC");
    $balanceReqs = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // Also fetch VIP requests
    try {
        $stmtVip = $pdo->query("SELECT vr.*, u.username FROM vip_requests vr LEFT JOIN users u ON vr.userId = u.id WHERE vr.status = 'PENDING' ORDER BY vr.createdAt ASC");
        $vipReqs = $stmtVip->fetchAll(PDO::FETCH_ASSOC);
    } catch(Exception $e) { $vipReqs = []; }

    // Fetch Active VIPs
    $activeVip = [];
    try {
        $now = time();
        $stmtActive = $pdo->query("SELECT id, username, avatarUrl, vipExpiry FROM users WHERE vipExpiry > $now ORDER BY vipExpiry ASC");
        $activeVip = $stmtActive->fetchAll(PDO::FETCH_ASSOC);
        foreach ($activeVip as &$u) {
            $u['avatarUrl'] = fix_url($u['avatarUrl']);
        }
    } catch(Exception $e) {}

    respond(true, ['balance' => $balanceReqs, 'vip' => $vipReqs, 'activeVip' => $activeVip]);
}

function admin_handle_vip_request($pdo, $input) {
    $reqId = $input['requestId'];
    $action = $input['action']; // APPROVED or REJECTED
    $adminId = $input['adminId'];
    
    $pdo->beginTransaction();
    try {
        $stmt = $pdo->prepare("SELECT userId, planSnapshot FROM vip_requests WHERE id = ? FOR UPDATE");
        $stmt->execute([$reqId]);
        $req = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$req) throw new Exception("Request not found");
        
        $plan = json_decode($req['planSnapshot'], true);
        
        $pdo->prepare("UPDATE vip_requests SET status = ? WHERE id = ?")->execute([$action, $reqId]);
        
        if ($action === 'APPROVED') {
            $revenue = floatval($plan['price']);
            $tid = uniqid('rev_');
            $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, NULL, NULL, ?, ?, 'VIP_REVENUE')")
                ->execute([$tid, $req['userId'], $revenue, time()]);

            if ($plan['type'] === 'BALANCE') {
                $baseAmount = floatval($plan['price']);
                $bonus = floatval($plan['bonusPercent'] ?? 0);
                $total = $baseAmount + ($baseAmount * ($bonus / 100));
                
                $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$total, $req['userId']]);
                
                $tid2 = uniqid('tx_vip_');
                $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, NULL, NULL, ?, ?, 'VIP')")
                    ->execute([$tid2, $req['userId'], $total, time()]);
                    
                $msg = "Tu recarga VIP de {$total} Saldo ha sido aprobada.";
                
            } else {
                $days = intval($plan['durationDays']);
                $seconds = $days * 86400;
                $now = time();
                
                $stmtUser = $pdo->prepare("SELECT vipExpiry FROM users WHERE id = ?");
                $stmtUser->execute([$req['userId']]);
                $currentExpiry = intval($stmtUser->fetchColumn());
                
                $newStart = ($currentExpiry > $now) ? $currentExpiry : $now;
                $newExpiry = $newStart + $seconds;
                
                $pdo->prepare("UPDATE users SET vipExpiry = ? WHERE id = ?")->execute([$newExpiry, $req['userId']]);
                
                $msg = "Tu Membresía VIP '{$plan['name']}' está activa hasta " . date('d/m/Y', $newExpiry);
            }
            
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], $msg, time()]);
        } else {
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], "Tu solicitud VIP fue rechazada.", time()]);
        }

        $pdo->commit();
        respond(true);
    } catch (Exception $e) {
        $pdo->rollBack();
        respond(false, null, $e->getMessage());
    }
}

function admin_get_global_transactions($pdo) {
    $sql = "SELECT t.*, b.username as buyerName, s.username as sellerName, v.title as videoTitle, m.title as itemTitle
            FROM transactions t
            LEFT JOIN users b ON t.buyerId = b.id
            LEFT JOIN users s ON t.creatorId = s.id
            LEFT JOIN videos v ON t.videoId = v.id
            LEFT JOIN marketplace_items m ON t.marketplaceItemId = m.id
            ORDER BY t.timestamp DESC LIMIT 100";
    $stmt = $pdo->query($sql);
    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

    $commissions = $pdo->query("SELECT SUM(adminFee) FROM transactions")->fetchColumn();
    $vipRevenue = $pdo->query("SELECT SUM(amount) FROM transactions WHERE type='VIP_REVENUE'")->fetchColumn();
    
    $totalRevenue = floatval($commissions) + floatval($vipRevenue);

    respond(true, ['history' => $rows, 'systemRevenue' => $totalRevenue]);
}

function admin_handle_balance_request($pdo, $input) {
    $reqId = $input['requestId'];
    $action = $input['action']; 
    $adminId = $input['adminId'];
    
    $pdo->beginTransaction();
    try {
        $stmt = $pdo->prepare("SELECT userId, amount FROM balance_requests WHERE id = ? FOR UPDATE");
        $stmt->execute([$reqId]);
        $req = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$req) throw new Exception("Request not found");
        
        $pdo->prepare("UPDATE balance_requests SET status = ? WHERE id = ?")->execute([$action, $reqId]);
        
        if ($action === 'APPROVED') {
            $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$req['amount'], $req['userId']]);
            
            $tid = uniqid('tx_dep_');
            $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, NULL, NULL, ?, ?, 'DEPOSIT')")
                ->execute([$tid, $req['userId'], $req['amount'], time()]);
                
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], "Your request for {$req['amount']} Saldo was approved.", time()]);
        } else {
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], "Your request for {$req['amount']} Saldo was declined.", time()]);
        }

        $pdo->commit();
        respond(true);
    } catch (Exception $e) {
        $pdo->rollBack();
        respond(false, null, $e->getMessage());
    }
}

function admin_cleanup_videos($pdo) {
    if (!is_dir(UPLOAD_DIR) || !is_readable(UPLOAD_DIR)) {
        respond(false, null, 'Error crítico: El directorio de videos no es accesible. Operación abortada para prevenir pérdida de datos.');
    }

    $stmt = $pdo->query("SELECT id, videoUrl FROM videos WHERE isLocal = 0");
    $videos = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $deleted = 0;
    
    foreach ($videos as $v) {
        $path = str_replace('api/', '', $v['videoUrl']);
        if (strpos($path, 'uploads/') !== 0) continue;
        
        if (!file_exists($path)) {
            $pdo->prepare("DELETE FROM videos WHERE id = ?")->execute([$v['id']]);
            $deleted++;
        }
    }
    respond(true, ['deleted' => $deleted]);
}

function admin_cleanup_system_files($pdo) {
    set_time_limit(600); 
    $stats = ['videos' => 0, 'thumbnails' => 0, 'avatars' => 0, 'market' => 0];
    
    $cleanName = function($path) { return basename($path); };

    $validVideos = [];
    $stmt = $pdo->query("SELECT videoUrl FROM videos");
    while ($path = $stmt->fetchColumn()) { $validVideos[] = $cleanName($path); }
    
    if (is_dir(UPLOAD_DIR) && is_readable(UPLOAD_DIR)) {
        $files = scandir(UPLOAD_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess') continue;
            if (!in_array($f, $validVideos)) { if (unlink(UPLOAD_DIR . $f)) $stats['videos']++; }
        }
    }

    $validThumbs = [];
    $stmt = $pdo->query("SELECT thumbnailUrl FROM videos");
    while ($path = $stmt->fetchColumn()) { $validThumbs[] = $cleanName($path); }
    
    if (is_dir(THUMB_DIR) && is_readable(THUMB_DIR)) {
        $files = scandir(THUMB_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess' || $f === 'default.jpg') continue;
            if (!in_array($f, $validThumbs)) { if (unlink(THUMB_DIR . $f)) $stats['thumbnails']++; }
        }
    }

    $validAvatars = [];
    $stmt = $pdo->query("SELECT avatarUrl FROM users WHERE avatarUrl IS NOT NULL");
    while ($path = $stmt->fetchColumn()) { $validAvatars[] = $cleanName($path); }
    
    if (is_dir(AVATAR_DIR) && is_readable(AVATAR_DIR)) {
        $files = scandir(AVATAR_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess') continue;
            if (!in_array($f, $validAvatars)) { if (unlink(AVATAR_DIR . $f)) $stats['avatars']++; }
        }
    }

    $validMarket = [];
    $stmt = $pdo->query("SELECT images FROM marketplace_items");
    while ($json = $stmt->fetchColumn()) {
        $imgs = json_decode($json, true);
        if (is_array($imgs)) { foreach ($imgs as $img) { $validMarket[] = $cleanName($img); } }
    }
    
    if (is_dir(MARKET_DIR) && is_readable(MARKET_DIR)) {
        $files = scandir(MARKET_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess') continue;
            if (!in_array($f, $validMarket)) { if (unlink(MARKET_DIR . $f)) $stats['market']++; }
        }
    }

    respond(true, $stats);
}

function admin_repair_db($pdo) {
    require_once 'functions_schema.php';
    $schema = getAppSchema();
    foreach ($schema as $tableName => $def) { syncTable($pdo, $tableName, $def); }
    respond(true);
}

function admin_smart_cleaner_preview($pdo, $input) {
    $cat = $input['category'];
    $percent = $input['percentage'];
    $safeDays = $input['safeHarborDays'];
    
    $where = "WHERE 1=1";
    if ($cat !== 'ALL') $where .= " AND category = '$cat'";
    
    $cutoff = time() - ($safeDays * 86400);
    $where .= " AND createdAt < $cutoff";
    
    $sql = "SELECT *, (views + (likes * 5) - (dislikes * 10)) as score FROM videos $where ORDER BY score ASC";
    $stmt = $pdo->query($sql);
    $allCandidates = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    $count = count($allCandidates);
    $limit = floor($count * ($percent / 100));
    if ($limit < 1 && $percent > 0 && $count > 0) $limit = 1;
    
    $toDelete = array_slice($allCandidates, 0, $limit);
    
    $space = 0;
    foreach ($toDelete as $v) {
        $path = str_replace('api/', '', $v['videoUrl']);
        if (file_exists($path)) $space += filesize($path);
        else $space += 50 * 1024 * 1024;
    }
    
    respond(true, [
        'preview' => $toDelete,
        'stats' => ['totalVideos' => $count, 'videosToDelete' => count($toDelete), 'spaceReclaimed' => round($space / 1024 / 1024, 2) . " MB"]
    ]);
}

function admin_smart_cleaner_execute($pdo, $input) {
    $ids = $input['videoIds'];
    $deleted = 0;
    foreach ($ids as $id) {
        $stmt = $pdo->prepare("SELECT videoUrl, thumbnailUrl FROM videos WHERE id = ?");
        $stmt->execute([$id]);
        $v = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($v) {
            $vidPath = str_replace('api/', '', $v['videoUrl']);
            if (file_exists($vidPath) && strpos($vidPath, 'uploads/') === 0) unlink($vidPath);
            $thumbPath = str_replace('api/', '', $v['thumbnailUrl']);
            if (strpos($thumbPath, 'http') === false && file_exists($thumbPath) && strpos($thumbPath, 'uploads/') === 0) unlink($thumbPath);
            
            $pdo->prepare("DELETE FROM videos WHERE id = ?")->execute([$id]);
            $deleted++;
        }
    }
    respond(true, ['deleted' => $deleted]);
}

// --- AI ORGANIZER (GEMINI API) ---
function admin_ai_organize($pdo, $input) {
    set_time_limit(180); // 3 minutes timeout
    
    $stmt = $pdo->query("SELECT geminiKey, customCategories, proxyUrl FROM system_settings LIMIT 1");
    $settings = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (empty($settings['geminiKey'])) {
        respond(false, null, "Falta la Gemini API Key en Configuración.");
    }

    $apiKey = $settings['geminiKey'];
    $proxy = $settings['proxyUrl'] ?? null;
    $customCats = json_decode($settings['customCategories'] ?? '[]', true);
    
    $availableCategories = [
        'GENERAL', 'MOVIES', 'SERIES', 'MUSIC', 'ADULT', 'KIDS', 'NEWS', 'SPORTS', 'GAMING', 'DOCUMENTARY', 'OTHER'
    ];
    if (!empty($customCats)) {
        $availableCategories = array_unique(array_merge($availableCategories, $customCats));
    }
    
    $catString = implode(', ', $availableCategories);

    // Fetch batch of videos
    $sql = "SELECT id, title, videoUrl FROM videos WHERE category IN ('GENERAL', 'OTHER', 'PROCESSING') ORDER BY id DESC LIMIT 50";
    $stmt = $pdo->query($sql);
    $videos = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if (empty($videos)) {
        respond(true, ['processed' => 0, 'message' => 'No hay videos pendientes de clasificar.']);
    }

    $prompt = "You are a video organizer assistant. I will provide a JSON list of video files.
    Your task is to classify each video into one of these exact categories: [{$catString}].
    Rules:
    1. Analyze the 'title' and the folder structure in 'videoUrl'.
    2. If path contains 'series', 'season', classify as SERIES.
    3. If path contains 'movies', classify as MOVIES.
    4. Return ONLY a JSON object where keys are IDs and values are categories.
    5. Valid JSON only.

    Input Data:
    " . json_encode($videos);

    // List of models to try in order (Fallback mechanism for 404/403)
    $candidateModels = ['gemini-1.5-flash', 'gemini-1.5-flash-latest', 'gemini-1.5-flash-001', 'gemini-pro'];
    
    $finalResponse = null;
    $lastError = "";

    foreach ($candidateModels as $model) {
        $url = "https://generativelanguage.googleapis.com/v1beta/models/$model:generateContent?key=" . $apiKey;
        
        $postBody = [
            "contents" => [["parts" => [["text" => $prompt]]]]
        ];

        // Legacy models (gemini-pro) do not support responseMimeType
        if (strpos($model, '1.5') !== false) {
            $postBody["generationConfig"] = ["responseMimeType" => "application/json"];
        }

        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($postBody));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        
        // FIX: Disable SSL verification for local dev/NAS environments
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
        
        // PROXY SUPPORT
        if (!empty($proxy)) {
            curl_setopt($ch, CURLOPT_PROXY, $proxy);
        }
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $curlError = curl_error($ch); 
        curl_close($ch);

        if ($httpCode === 200 && $response) {
            $finalResponse = $response;
            break; // Success!
        } else {
            $lastError = "Model $model failed ($httpCode). ";
            if ($response) {
                // Check if 404 Model not found
                if ($httpCode === 404) { continue; } // Try next model
            }
        }
    }

    if (!$finalResponse) {
        respond(false, null, "All models failed. Last error: " . $lastError);
    }

    $jsonRes = json_decode($finalResponse, true);
    $rawText = $jsonRes['candidates'][0]['content']['parts'][0]['text'] ?? '';
    
    // Clean Markdown
    $rawText = str_replace(['```json', '```'], '', $rawText);
    
    // Fallback parser if not strict JSON (e.g. from gemini-pro)
    $firstBrace = strpos($rawText, '{');
    $lastBrace = strrpos($rawText, '}');
    if ($firstBrace !== false && $lastBrace !== false) {
        $rawText = substr($rawText, $firstBrace, $lastBrace - $firstBrace + 1);
    }

    $classification = json_decode(trim($rawText), true);

    if (!$classification || !is_array($classification)) {
        respond(false, null, "Failed to parse AI response.");
    }

    // Update DB
    $updatedCount = 0;
    $updateStmt = $pdo->prepare("UPDATE videos SET category = ? WHERE id = ?");
    
    foreach ($classification as $vidId => $cat) {
        $upperCat = strtoupper(trim($cat));
        if (in_array($upperCat, $availableCategories)) {
            $updateStmt->execute([$upperCat, $vidId]);
            $updatedCount++;
        }
    }

    respond(true, ['processed' => $updatedCount, 'details' => $classification]);
}

function admin_get_requests($pdo, $status) {
    $sql = "SELECT r.*, u.username FROM requests r LEFT JOIN users u ON r.userId = u.id";
    if ($status && $status !== 'ALL') $sql .= " WHERE r.status = '$status'";
    $sql .= " ORDER BY r.createdAt DESC";
    $stmt = $pdo->query($sql);
    respond(true, $stmt->fetchAll(PDO::FETCH_ASSOC));
}

function admin_update_request_status($pdo, $input) {
    $id = $input['id'];
    $status = $input['status'];
    $pdo->prepare("UPDATE requests SET status = ? WHERE id = ?")->execute([$status, $id]);
    
    $stmt = $pdo->prepare("SELECT userId, query FROM requests WHERE id = ?");
    $stmt->execute([$id]);
    $req = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($req && $status === 'COMPLETED') {
        $nid = uniqid('n_');
        $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
            ->execute([$nid, $req['userId'], "Tu petición '{$req['query']}' ha sido completada y añadida.", time()]);
    }
    respond(true);
}

function admin_request_content($pdo, $input) {
    $rid = uniqid('req_');
    $pdo->prepare("INSERT INTO requests (id, userId, query, status, createdAt, useLocalNetwork) VALUES (?, ?, ?, 'PENDING', ?, ?)")
        ->execute([$rid, $input['userId'], $input['query'], time(), $input['useLocalNetwork'] ? 1 : 0]);
    respond(true, ['id' => $rid]);
}

function admin_delete_request($pdo, $input) {
    $pdo->prepare("DELETE FROM requests WHERE id = ?")->execute([$input['requestId']]);
    respond(true);
}

function admin_get_settings($pdo) {
    $stmt = $pdo->query("SELECT * FROM system_settings WHERE id = 1");
    $s = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$s) {
        $pdo->exec("INSERT IGNORE INTO system_settings (id) VALUES (1)");
        $s = $pdo->query("SELECT * FROM system_settings WHERE id = 1")->fetch(PDO::FETCH_ASSOC);
    }

    $catPrices = json_decode($s['categoryPrices'] ?? '{}', true) ?: new stdClass();

    $settings = [
        'id' => 1,
        'downloadStartTime' => $s['downloadStartTime'] ?? '01:00',
        'downloadEndTime' => $s['downloadEndTime'] ?? '06:00',
        'isQueuePaused' => (bool)($s['isQueuePaused'] ?? 0),
        'batchSize' => intval($s['batchSize'] ?? 5),
        'maxDuration' => intval($s['maxDuration'] ?? 600),
        'maxResolution' => intval($s['maxResolution'] ?? 1080),
        'pexelsKey' => $s['pexelsKey'] ?? '',
        'pixabayKey' => $s['pixabayKey'] ?? '',
        'geminiKey' => $s['geminiKey'] ?? '', 
        'ytDlpPath' => $s['ytDlpPath'] ?? '',
        'enableYoutube' => (bool)($s['enableYoutube'] ?? 0),
        'categoryPrices' => $catPrices,
        'customCategories' => json_decode($s['customCategories'] ?? '[]', true) ?: [],
        'localLibraryPath' => $s['localLibraryPath'] ?? '',
        'ftpSettings' => json_decode($s['ftpSettings'] ?? '{}', true) ?: [],
        'videoCommission' => intval($s['videoCommission'] ?? 20),
        'marketCommission' => intval($s['marketCommission'] ?? 25),
        'vipPlans' => json_decode($s['vipPlans'] ?? '[]', true) ?: [],
        'paymentInstructions' => $s['paymentInstructions'] ?? '',
        'tropipayClientId' => $s['tropipayClientId'] ?? '',
        'tropipayClientSecret' => $s['tropipayClientSecret'] ?? '',
        'currencyConversion' => floatval($s['currencyConversion']) ?? 1.00,
        'proxyUrl' => $s['proxyUrl'] ?? ''
    ];
    
    if (empty($settings['vipPlans'])) {
        $settings['vipPlans'] = [
            ['id' => 'v1', 'name' => 'VIP Mensual', 'price' => 1000, 'type' => 'ACCESS', 'durationDays' => 30, 'description' => 'Acceso total a todos los videos por 30 días.'],
            ['id' => 'r1', 'name' => 'Recarga +20%', 'price' => 300, 'type' => 'BALANCE', 'bonusPercent' => 20, 'description' => 'Recibes 360 de Saldo.']
        ];
    }

    respond(true, $settings);
}

function admin_update_settings($pdo, $input) {
    $s = $input['settings'];
    
    require_once 'functions_schema.php';
    syncTable($pdo, 'system_settings', getAppSchema()['system_settings']);

    $sql = "UPDATE system_settings SET 
            downloadStartTime = ?, 
            downloadEndTime = ?, 
            isQueuePaused = ?, 
            batchSize = ?, 
            maxDuration = ?, 
            maxResolution = ?, 
            pexelsKey = ?, 
            pixabayKey = ?,
            geminiKey = ?,
            ytDlpPath = ?,
            enableYoutube = ?,
            categoryPrices = ?,
            customCategories = ?,
            localLibraryPath = ?,
            ftpSettings = ?,
            videoCommission = ?,
            marketCommission = ?,
            vipPlans = ?,
            paymentInstructions = ?,
            tropipayClientId = ?,
            tropipayClientSecret = ?,
            currencyConversion = ?,
            proxyUrl = ?
            WHERE id = 1";
            
    $pdo->prepare($sql)->execute([
        $s['downloadStartTime'] ?? '01:00', 
        $s['downloadEndTime'] ?? '06:00', 
        isset($s['isQueuePaused']) ? ($s['isQueuePaused'] ? 1 : 0) : 0, 
        intval($s['batchSize'] ?? 5), 
        intval($s['maxDuration'] ?? 600), 
        intval($s['maxResolution'] ?? 1080), 
        $s['pexelsKey'] ?? '', 
        $s['pixabayKey'] ?? '',
        $s['geminiKey'] ?? '',
        $s['ytDlpPath'] ?? '',
        isset($s['enableYoutube']) ? ($s['enableYoutube'] ? 1 : 0) : 0,
        json_encode($s['categoryPrices'] ?? new stdClass()), 
        json_encode($s['customCategories'] ?? []),
        $s['localLibraryPath'] ?? '',
        json_encode($s['ftpSettings'] ?? []),
        intval($s['videoCommission'] ?? 20),
        intval($s['marketCommission'] ?? 25),
        json_encode($s['vipPlans'] ?? []),
        $s['paymentInstructions'] ?? '',
        $s['tropipayClientId'] ?? '',
        $s['tropipayClientSecret'] ?? '',
        floatval($s['currencyConversion']) ?? 1.00,
        $s['proxyUrl'] ?? ''
    ]);
    respond(true);
}

function admin_search_external($pdo, $input) {
    $query = $input['query'];
    $source = $input['source'];
    $results = [];
    
    $stmt = $pdo->query("SELECT pexelsKey, pixabayKey, enableYoutube, ytDlpPath FROM system_settings LIMIT 1");
    $keys = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($source === 'YOUTUBE') {
        $results = get_youtube_video($query, $keys);
    } else {
        if (!empty($keys['pixabayKey'])) {
             $url = "https://pixabay.com/api/videos/?key={$keys['pixabayKey']}&q=" . urlencode($query);
             $res = @file_get_contents($url);
             if ($res) {
                 $data = json_decode($res, true);
                 foreach ($data['hits'] as $hit) {
                     $thumb = $hit['userImageURL'] ?: "";
                     $results[] = [
                         'id' => 'pix_' . $hit['id'],
                         'source' => 'Pixabay',
                         'thumbnail' => $thumb,
                         'title' => "Stock Video " . $hit['id'],
                         'downloadUrl' => $hit['videos']['medium']['url'],
                         'author' => $hit['user'],
                         'duration' => $hit['duration']
                     ];
                 }
             }
        }
    }
    respond(true, $results);
}

function admin_process_queue($pdo) {
    respond(true, ['processed' => 0, 'message' => 'Queue triggered (Simulation)']);
}

function admin_get_real_stats($pdo) {
    $stats = [];
    $stats['userCount'] = $pdo->query("SELECT COUNT(*) FROM users")->fetchColumn();
    $stmt = $pdo->query("SELECT id FROM users WHERE role='ADMIN' LIMIT 1");
    $adminId = $stmt->fetchColumn();
    $monthAgo = time() - (30*24*60*60);
    $stats['adminVideoSales'] = $pdo->query("SELECT COUNT(*) FROM transactions WHERE creatorId = '$adminId' AND type='PURCHASE' AND timestamp > $monthAgo")->fetchColumn();
    $stats['avgDeposit'] = $pdo->query("SELECT AVG(amount) FROM transactions WHERE type IN ('DEPOSIT', 'VIP_REVENUE')")->fetchColumn() ?: 0;
    respond(true, $stats);
}
?>
