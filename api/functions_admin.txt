
<?php
function admin_add_balance($pdo, $input) {
    $adminId = $input['adminId'];
    // Verify admin
    $stmt = $pdo->prepare("SELECT role FROM users WHERE id = ?");
    $stmt->execute([$adminId]);
    if ($stmt->fetchColumn() !== 'ADMIN') respond(false, null, 'Unauthorized');

    $target = $input['targetUserId'];
    $amount = $input['amount'];

    $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$amount, $target]);
    
    // Log deposit
    $tid = uniqid('tx_dep_');
    $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, NULL, NULL, ?, ?, 'DEPOSIT')")
        ->execute([$tid, $target, $amount, time()]);
        
    respond(true);
}

// User Action: Request Balance
function user_request_balance($pdo, $input) {
    $id = uniqid('br_');
    $userId = $input['userId'];
    $amount = $input['amount'];
    
    $pdo->prepare("INSERT INTO balance_requests (id, userId, amount, status, createdAt) VALUES (?, ?, ?, 'PENDING', ?)")
        ->execute([$id, $userId, $amount, time()]);
        
    respond(true);
}

// Admin Action: Get Requests
function admin_get_balance_requests($pdo) {
    $stmt = $pdo->query("SELECT br.*, u.username FROM balance_requests br LEFT JOIN users u ON br.userId = u.id WHERE br.status = 'PENDING' ORDER BY br.createdAt ASC");
    $balanceReqs = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // Also fetch VIP requests
    // Need to ensure table exists in case of update
    try {
        $stmtVip = $pdo->query("SELECT vr.*, u.username FROM vip_requests vr LEFT JOIN users u ON vr.userId = u.id WHERE vr.status = 'PENDING' ORDER BY vr.createdAt ASC");
        $vipReqs = $stmtVip->fetchAll(PDO::FETCH_ASSOC);
    } catch(Exception $e) { $vipReqs = []; }

    respond(true, ['balance' => $balanceReqs, 'vip' => $vipReqs]);
}

function admin_handle_vip_request($pdo, $input) {
    $reqId = $input['requestId'];
    $action = $input['action']; // APPROVED or REJECTED
    $adminId = $input['adminId'];
    
    $pdo->beginTransaction();
    try {
        $stmt = $pdo->prepare("SELECT userId, planSnapshot FROM vip_requests WHERE id = ? FOR UPDATE");
        $stmt->execute([$reqId]);
        $req = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$req) throw new Exception("Request not found");
        
        $plan = json_decode($req['planSnapshot'], true);
        
        $pdo->prepare("UPDATE vip_requests SET status = ? WHERE id = ?")->execute([$action, $reqId]);
        
        if ($action === 'APPROVED') {
            if ($plan['type'] === 'BALANCE') {
                // Balance Bonus Logic
                $baseAmount = floatval($plan['price']);
                $bonus = floatval($plan['bonusPercent'] ?? 0);
                $total = $baseAmount + ($baseAmount * ($bonus / 100));
                
                $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$total, $req['userId']]);
                
                // Transaction Log
                $tid = uniqid('tx_vip_');
                $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, NULL, NULL, ?, ?, 'VIP')")
                    ->execute([$tid, $req['userId'], $total, time()]);
                    
                $msg = "Tu recarga VIP de {$total} Saldo ha sido aprobada.";
                
            } else {
                // Access Logic (Time based)
                $days = intval($plan['durationDays']);
                $seconds = $days * 86400;
                $now = time();
                
                // Get current expiry
                $stmtUser = $pdo->prepare("SELECT vipExpiry FROM users WHERE id = ?");
                $stmtUser->execute([$req['userId']]);
                $currentExpiry = intval($stmtUser->fetchColumn());
                
                // Extend if already active, else start from now
                $newStart = ($currentExpiry > $now) ? $currentExpiry : $now;
                $newExpiry = $newStart + $seconds;
                
                $pdo->prepare("UPDATE users SET vipExpiry = ? WHERE id = ?")->execute([$newExpiry, $req['userId']]);
                
                $msg = "Tu Membresía VIP '{$plan['name']}' está activa hasta " . date('d/m/Y', $newExpiry);
            }
            
            // Notify User
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], $msg, time()]);
        } else {
             // Notify Rejection
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], "Tu solicitud VIP fue rechazada.", time()]);
        }

        $pdo->commit();
        respond(true);
    } catch (Exception $e) {
        $pdo->rollBack();
        respond(false, null, $e->getMessage());
    }
}

function admin_get_global_transactions($pdo) {
    // Fetch last 100 transactions of any type
    $sql = "SELECT t.*, b.username as buyerName, s.username as sellerName, v.title as videoTitle, m.title as itemTitle
            FROM transactions t
            LEFT JOIN users b ON t.buyerId = b.id
            LEFT JOIN users s ON t.creatorId = s.id
            LEFT JOIN videos v ON t.videoId = v.id
            LEFT JOIN marketplace_items m ON t.marketplaceItemId = m.id
            ORDER BY t.timestamp DESC LIMIT 100";
    $stmt = $pdo->query($sql);
    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
    respond(true, $rows);
}

// Admin Action: Handle Request
function admin_handle_balance_request($pdo, $input) {
    $reqId = $input['requestId'];
    $action = $input['action']; // APPROVED or REJECTED
    $adminId = $input['adminId'];
    
    $pdo->beginTransaction();
    try {
        $stmt = $pdo->prepare("SELECT userId, amount FROM balance_requests WHERE id = ? FOR UPDATE");
        $stmt->execute([$reqId]);
        $req = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$req) throw new Exception("Request not found");
        
        $pdo->prepare("UPDATE balance_requests SET status = ? WHERE id = ?")->execute([$action, $reqId]);
        
        if ($action === 'APPROVED') {
            // Add Balance
            $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$req['amount'], $req['userId']]);
            
            // Log Transaction
            $tid = uniqid('tx_dep_');
            $pdo->prepare("INSERT INTO transactions (id, buyerId, creatorId, videoId, amount, timestamp, type) VALUES (?, ?, NULL, NULL, ?, ?, 'DEPOSIT')")
                ->execute([$tid, $req['userId'], $req['amount'], time()]);
                
            // Notify User
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], "Your request for {$req['amount']} Saldo was approved.", time()]);
        } else {
             // Notify Rejection
            $nid = uniqid('n_');
            $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
                ->execute([$nid, $req['userId'], "Your request for {$req['amount']} Saldo was declined.", time()]);
        }

        $pdo->commit();
        respond(true);
    } catch (Exception $e) {
        $pdo->rollBack();
        respond(false, null, $e->getMessage());
    }
}

// Database Cleanup: Removes DB rows if file is missing (Safe logic)
function admin_cleanup_videos($pdo) {
    // SECURITY: Ensure the upload directory is actually accessible before deleting DB records
    if (!is_dir(UPLOAD_DIR) || !is_readable(UPLOAD_DIR)) {
        respond(false, null, 'Error crítico: El directorio de videos no es accesible. Operación abortada para prevenir pérdida de datos.');
    }

    $stmt = $pdo->query("SELECT id, videoUrl FROM videos WHERE isLocal = 0");
    $videos = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $deleted = 0;
    
    foreach ($videos as $v) {
        $path = str_replace('api/', '', $v['videoUrl']);
        
        // SECURITY: Only delete if inside uploads directory
        if (strpos($path, 'uploads/') !== 0) continue;
        
        if (!file_exists($path)) {
            $pdo->prepare("DELETE FROM videos WHERE id = ?")->execute([$v['id']]);
            $deleted++;
        }
    }
    respond(true, ['deleted' => $deleted]);
}

// Filesystem Cleanup: Removes physical files if not in DB (Orphaned files)
function admin_cleanup_system_files($pdo) {
    set_time_limit(600); // 10 minutes for large libraries
    $stats = ['videos' => 0, 'thumbnails' => 0, 'avatars' => 0, 'market' => 0];
    
    // Helper to extract clean filename from DB path
    $cleanName = function($path) {
        return basename($path);
    };

    // --- 1. CLEAN VIDEOS ---
    $validVideos = [];
    $stmt = $pdo->query("SELECT videoUrl FROM videos");
    while ($path = $stmt->fetchColumn()) {
        $validVideos[] = $cleanName($path);
    }
    
    if (is_dir(UPLOAD_DIR) && is_readable(UPLOAD_DIR)) {
        $files = scandir(UPLOAD_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess') continue;
            if (!in_array($f, $validVideos)) {
                if (unlink(UPLOAD_DIR . $f)) $stats['videos']++;
            }
        }
    }

    // --- 2. CLEAN THUMBNAILS ---
    $validThumbs = [];
    $stmt = $pdo->query("SELECT thumbnailUrl FROM videos");
    while ($path = $stmt->fetchColumn()) {
        $validThumbs[] = $cleanName($path);
    }
    
    if (is_dir(THUMB_DIR) && is_readable(THUMB_DIR)) {
        $files = scandir(THUMB_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess' || $f === 'default.jpg') continue;
            // Thumbnails usually have IDs, but let's be strict
            if (!in_array($f, $validThumbs)) {
                if (unlink(THUMB_DIR . $f)) $stats['thumbnails']++;
            }
        }
    }

    // --- 3. CLEAN AVATARS (Users + Marketplace History) ---
    $validAvatars = [];
    $stmt = $pdo->query("SELECT avatarUrl FROM users WHERE avatarUrl IS NOT NULL");
    while ($path = $stmt->fetchColumn()) {
        $validAvatars[] = $cleanName($path);
    }
    // Also include marketplace buyer/seller avatars cache if any (usually linked to users, but check notifications/messages if implemented)
    
    if (is_dir(AVATAR_DIR) && is_readable(AVATAR_DIR)) {
        $files = scandir(AVATAR_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess') continue;
            if (!in_array($f, $validAvatars)) {
                if (unlink(AVATAR_DIR . $f)) $stats['avatars']++;
            }
        }
    }

    // --- 4. CLEAN MARKETPLACE IMAGES ---
    $validMarket = [];
    $stmt = $pdo->query("SELECT images FROM marketplace_items");
    while ($json = $stmt->fetchColumn()) {
        $imgs = json_decode($json, true);
        if (is_array($imgs)) {
            foreach ($imgs as $img) {
                $validMarket[] = $cleanName($img);
            }
        }
    }
    
    if (is_dir(MARKET_DIR) && is_readable(MARKET_DIR)) {
        $files = scandir(MARKET_DIR);
        foreach ($files as $f) {
            if ($f === '.' || $f === '..' || $f === 'index.php' || $f === '.htaccess') continue;
            if (!in_array($f, $validMarket)) {
                if (unlink(MARKET_DIR . $f)) $stats['market']++;
            }
        }
    }

    respond(true, $stats);
}

function admin_repair_db($pdo) {
    require_once 'functions_schema.php';
    $schema = getAppSchema();
    
    foreach ($schema as $tableName => $def) {
        syncTable($pdo, $tableName, $def);
    }
    
    respond(true);
}

function admin_smart_cleaner_preview($pdo, $input) {
    $cat = $input['category'];
    $percent = $input['percentage'];
    $safeDays = $input['safeHarborDays'];
    
    // Build Query
    $where = "WHERE 1=1";
    if ($cat !== 'ALL') $where .= " AND category = '$cat'";
    
    // Safe Harbor
    $cutoff = time() - ($safeDays * 86400);
    $where .= " AND createdAt < $cutoff";
    
    // Score: Views + (Likes * 5) - (Dislikes * 10)
    // We want to delete LOWEST scores.
    $sql = "SELECT *, (views + (likes * 5) - (dislikes * 10)) as score FROM videos $where ORDER BY score ASC";
    $stmt = $pdo->query($sql);
    $allCandidates = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    $count = count($allCandidates);
    $limit = floor($count * ($percent / 100));
    // Ensure we don't delete everything if list is small but percentage is high
    if ($limit < 1 && $percent > 0 && $count > 0) $limit = 1;
    
    $toDelete = array_slice($allCandidates, 0, $limit);
    
    // Estimate space (very rough, average 50MB if file missing)
    $space = 0;
    foreach ($toDelete as $v) {
        $path = str_replace('api/', '', $v['videoUrl']);
        if (file_exists($path)) $space += filesize($path);
        else $space += 50 * 1024 * 1024; // Fallback estimate
    }
    
    respond(true, [
        'preview' => $toDelete,
        'stats' => [
            'totalVideos' => $count,
            'videosToDelete' => count($toDelete),
            'spaceReclaimed' => round($space / 1024 / 1024, 2) . " MB"
        ]
    ]);
}

function admin_smart_cleaner_execute($pdo, $input) {
    $ids = $input['videoIds'];
    $deleted = 0;
    foreach ($ids as $id) {
        $stmt = $pdo->prepare("SELECT videoUrl, thumbnailUrl FROM videos WHERE id = ?");
        $stmt->execute([$id]);
        $v = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($v) {
            // Delete Files
            $vidPath = str_replace('api/', '', $v['videoUrl']);
            // SECURITY: Only delete if inside uploads directory
            if (file_exists($vidPath) && strpos($vidPath, 'uploads/') === 0) unlink($vidPath);
            
            $thumbPath = str_replace('api/', '', $v['thumbnailUrl']);
            // Only delete if local upload (not http) and safe
            if (strpos($thumbPath, 'http') === false && file_exists($thumbPath) && strpos($thumbPath, 'uploads/') === 0) unlink($thumbPath);
            
            $pdo->prepare("DELETE FROM videos WHERE id = ?")->execute([$id]);
            $deleted++;
        }
    }
    respond(true, ['deleted' => $deleted]);
}

function admin_get_requests($pdo, $status) {
    $sql = "SELECT r.*, u.username FROM requests r LEFT JOIN users u ON r.userId = u.id";
    if ($status && $status !== 'ALL') $sql .= " WHERE r.status = '$status'";
    $sql .= " ORDER BY r.createdAt DESC";
    
    $stmt = $pdo->query($sql);
    respond(true, $stmt->fetchAll(PDO::FETCH_ASSOC));
}

function admin_update_request_status($pdo, $input) {
    $id = $input['id'];
    $status = $input['status'];
    $pdo->prepare("UPDATE requests SET status = ? WHERE id = ?")->execute([$status, $id]);
    
    // Notify User
    $stmt = $pdo->prepare("SELECT userId, query FROM requests WHERE id = ?");
    $stmt->execute([$id]);
    $req = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($req && $status === 'COMPLETED') {
        $nid = uniqid('n_');
        $pdo->prepare("INSERT INTO notifications (id, userId, type, text, link, isRead, timestamp) VALUES (?, ?, 'SYSTEM', ?, '/profile', 0, ?)")
            ->execute([$nid, $req['userId'], "Tu petición '{$req['query']}' ha sido completada y añadida.", time()]);
    }
    
    respond(true);
}

function admin_request_content($pdo, $input) {
    $rid = uniqid('req_');
    $pdo->prepare("INSERT INTO requests (id, userId, query, status, createdAt, useLocalNetwork) VALUES (?, ?, ?, 'PENDING', ?, ?)")
        ->execute([$rid, $input['userId'], $input['query'], time(), $input['useLocalNetwork'] ? 1 : 0]);
    respond(true, ['id' => $rid]);
}

function admin_delete_request($pdo, $input) {
    $pdo->prepare("DELETE FROM requests WHERE id = ?")->execute([$input['requestId']]);
    respond(true);
}

function admin_get_settings($pdo) {
    $stmt = $pdo->query("SELECT * FROM system_settings WHERE id = 1");
    $s = $stmt->fetch(PDO::FETCH_ASSOC);
    
    // Ensure we always return settings, even if default is missing
    if (!$s) {
        $pdo->exec("INSERT IGNORE INTO system_settings (id) VALUES (1)");
        $s = $pdo->query("SELECT * FROM system_settings WHERE id = 1")->fetch(PDO::FETCH_ASSOC);
    }

    // Default object structure to prevent frontend "empty" issues
    $settings = [
        'id' => 1,
        'downloadStartTime' => $s['downloadStartTime'] ?? '01:00',
        'downloadEndTime' => $s['downloadEndTime'] ?? '06:00',
        'isQueuePaused' => (bool)($s['isQueuePaused'] ?? 0),
        'batchSize' => intval($s['batchSize'] ?? 5),
        'maxDuration' => intval($s['maxDuration'] ?? 600),
        'maxResolution' => intval($s['maxResolution'] ?? 1080),
        'pexelsKey' => $s['pexelsKey'] ?? '',
        'pixabayKey' => $s['pixabayKey'] ?? '',
        'ytDlpPath' => $s['ytDlpPath'] ?? '',
        'enableYoutube' => (bool)($s['enableYoutube'] ?? 0),
        'categoryPrices' => json_decode($s['categoryPrices'] ?? '{}', true) ?: [],
        'customCategories' => json_decode($s['customCategories'] ?? '[]', true) ?: [],
        'localLibraryPath' => $s['localLibraryPath'] ?? '',
        'ftpSettings' => json_decode($s['ftpSettings'] ?? '{}', true) ?: [],
        'videoCommission' => intval($s['videoCommission'] ?? 20),
        'marketCommission' => intval($s['marketCommission'] ?? 25),
        'vipPlans' => json_decode($s['vipPlans'] ?? '[]', true) ?: [],
        'paymentInstructions' => $s['paymentInstructions'] ?? '',
        'tropipayClientId' => $s['tropipayClientId'] ?? '',
        'tropipayClientSecret' => $s['tropipayClientSecret'] ?? '',
        'currencyConversion' => floatval($s['currencyConversion']) ?? 1.00
    ];
    
    // DEFAULT VIP PLANS IF EMPTY
    if (empty($settings['vipPlans'])) {
        $settings['vipPlans'] = [
            ['id' => 'v1', 'name' => 'VIP Mensual', 'price' => 1000, 'type' => 'ACCESS', 'durationDays' => 30, 'description' => 'Acceso total a todos los videos por 30 días.'],
            ['id' => 'v2', 'name' => 'VIP Quincenal', 'price' => 800, 'type' => 'ACCESS', 'durationDays' => 15, 'description' => 'Acceso total por 15 días.'],
            ['id' => 'v3', 'name' => 'VIP Semanal', 'price' => 500, 'type' => 'ACCESS', 'durationDays' => 7, 'description' => 'Acceso total por 7 días.'],
            ['id' => 'r1', 'name' => 'Recarga +20%', 'price' => 300, 'type' => 'BALANCE', 'bonusPercent' => 20, 'description' => 'Recibes 360 de Saldo.'],
            ['id' => 'r2', 'name' => 'Recarga +10%', 'price' => 200, 'type' => 'BALANCE', 'bonusPercent' => 10, 'description' => 'Recibes 220 de Saldo.'],
            ['id' => 'r3', 'name' => 'Recarga +5%', 'price' => 100, 'type' => 'BALANCE', 'bonusPercent' => 5, 'description' => 'Recibes 105 de Saldo.']
        ];
    }

    respond(true, $settings);
}

function admin_update_settings($pdo, $input) {
    $s = $input['settings'];
    
    // Ensure table has vipPlans column
    require_once 'functions_schema.php';
    syncTable($pdo, 'system_settings', getAppSchema()['system_settings']);

    $sql = "UPDATE system_settings SET 
            downloadStartTime = ?, 
            downloadEndTime = ?, 
            isQueuePaused = ?, 
            batchSize = ?, 
            maxDuration = ?, 
            maxResolution = ?, 
            pexelsKey = ?, 
            pixabayKey = ?,
            ytDlpPath = ?,
            enableYoutube = ?,
            categoryPrices = ?,
            customCategories = ?,
            localLibraryPath = ?,
            ftpSettings = ?,
            videoCommission = ?,
            marketCommission = ?,
            vipPlans = ?,
            paymentInstructions = ?,
            tropipayClientId = ?,
            tropipayClientSecret = ?,
            currencyConversion = ?
            WHERE id = 1";
            
    $pdo->prepare($sql)->execute([
        $s['downloadStartTime'] ?? '01:00', 
        $s['downloadEndTime'] ?? '06:00', 
        isset($s['isQueuePaused']) ? ($s['isQueuePaused'] ? 1 : 0) : 0, 
        intval($s['batchSize'] ?? 5), 
        intval($s['maxDuration'] ?? 600), 
        intval($s['maxResolution'] ?? 1080), 
        $s['pexelsKey'] ?? '', 
        $s['pixabayKey'] ?? '',
        $s['ytDlpPath'] ?? '',
        isset($s['enableYoutube']) ? ($s['enableYoutube'] ? 1 : 0) : 0,
        json_encode($s['categoryPrices'] ?? []),
        json_encode($s['customCategories'] ?? []),
        $s['localLibraryPath'] ?? '',
        json_encode($s['ftpSettings'] ?? []),
        intval($s['videoCommission'] ?? 20),
        intval($s['marketCommission'] ?? 25),
        json_encode($s['vipPlans'] ?? []),
        $s['paymentInstructions'] ?? '',
        $s['tropipayClientId'] ?? '',
        $s['tropipayClientSecret'] ?? '',
        floatval($s['currencyConversion']) ?? 1.00
    ]);
    respond(true);
}

function admin_search_external($pdo, $input) {
    $query = $input['query'];
    $source = $input['source'];
    $results = [];
    
    $stmt = $pdo->query("SELECT pexelsKey, pixabayKey, enableYoutube, ytDlpPath FROM system_settings LIMIT 1");
    $keys = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($source === 'YOUTUBE') {
        $results = get_youtube_video($query, $keys);
    } else {
        // STOCK LOGIC (Pexels/Pixabay) - Simplified for brevity
        if (!empty($keys['pixabayKey'])) {
             $url = "https://pixabay.com/api/videos/?key={$keys['pixabayKey']}&q=" . urlencode($query);
             $res = @file_get_contents($url);
             if ($res) {
                 $data = json_decode($res, true);
                 foreach ($data['hits'] as $hit) {
                     // FIX: If userImageURL is missing, use empty string to let frontend handle it, 
                     // or use local default. Ideally frontend handles empty.
                     $thumb = $hit['userImageURL'] ?: "";
                     
                     $results[] = [
                         'id' => 'pix_' . $hit['id'],
                         'source' => 'Pixabay',
                         'thumbnail' => $thumb,
                         'title' => "Stock Video " . $hit['id'],
                         'downloadUrl' => $hit['videos']['medium']['url'],
                         'author' => $hit['user'],
                         'duration' => $hit['duration']
                     ];
                 }
             }
        }
    }
    respond(true, $results);
}

function admin_process_queue($pdo) {
    // This is a stub for manual trigger. 
    // In a real env, this would invoke the background worker script.
    // We return success to the UI.
    respond(true, ['processed' => 0, 'message' => 'Queue triggered (Simulation)']);
}
?>
