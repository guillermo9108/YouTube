<?php
/**
 * ADMINISTRACIÓN - CORE FUNCTIONS V14.0 (Mix de Ventas & Simulador Dinámico)
 */

function admin_get_settings($pdo) {
    $stmt = $pdo->query("SELECT * FROM system_settings WHERE id = 1");
    $settings = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($settings) {
        $settings['categoryPrices'] = json_decode($settings['categoryPrices'] ?? '{}', true);
        $settings['categories'] = json_decode($settings['categories'] ?? '[]', true);
        $settings['libraryPaths'] = json_decode($settings['libraryPaths'] ?? '[]', true);
        $settings['vipPlans'] = json_decode($settings['vipPlans'] ?? '[]', true);
        $settings['ftpSettings'] = json_decode($settings['ftpSettings'] ?? '{}', true);
        respond(true, $settings);
    }
    respond(false, null, "No se pudo cargar la configuración");
}

function get_real_stats($pdo) {
    $from = $_GET['from'] ?? (time() - (30 * 86400));
    $to = $_GET['to'] ?? time();

    $userCount = $pdo->query("SELECT COUNT(*) FROM users")->fetchColumn() ?: 1;
    
    // 1. Auditoría Financiera
    $stmtRevenue = $pdo->prepare("
        SELECT 
            SUM(CASE WHEN type IN ('PURCHASE', 'MARKETPLACE', 'TRANSFER_SENT') THEN adminFee ELSE 0 END) as total_commissions,
            SUM(CASE WHEN type = 'VIP' THEN amount ELSE 0 END) as total_vip_sales,
            COUNT(DISTINCT buyerId) as active_buyers,
            COUNT(*) as total_tx
        FROM transactions 
        WHERE timestamp BETWEEN ? AND ?
    ");
    $stmtRevenue->execute([$from, $to]);
    $rev = $stmtRevenue->fetch();

    $totalRevenue = floatval($rev['total_commissions'] ?? 0) + floatval($rev['total_vip_sales'] ?? 0);
    $activeUsers = intval($rev['active_buyers'] ?? 0);
    $totalTx = intval($rev['total_tx'] ?? 0);

    // 2. Mix de Ventas por Nombre de Plan (Utilizado por el Simulador)
    $stmtMix = $pdo->prepare("
        SELECT videoTitle as planName, COUNT(*) as qty 
        FROM transactions 
        WHERE type = 'VIP' AND timestamp BETWEEN ? AND ?
        GROUP BY videoTitle
    ");
    $stmtMix->execute([$from, $to]);
    $planMix = $stmtMix->fetchAll(PDO::FETCH_KEY_PAIR) ?: [];

    // 3. Historial de Crecimiento
    $stmtD = $pdo->prepare("
        SELECT FROM_UNIXTIME(timestamp, '%Y-%m-%d') as date, 
               SUM(CASE WHEN type = 'VIP' THEN amount ELSE adminFee END) as revenue 
        FROM transactions 
        WHERE timestamp BETWEEN ? AND ? 
        GROUP BY date 
        ORDER BY date ASC
    ");
    $stmtD->execute([$from, $to]);
    $daily = $stmtD->fetchAll();

    $conversion = ($userCount > 0) ? round(($activeUsers / $userCount) * 100, 2) : 0;
    $arpu = ($activeUsers > 0) ? round($totalRevenue / $activeUsers, 2) : 0;
    $frequency = ($activeUsers > 0) ? round($totalTx / $activeUsers, 2) : 1;
    
    respond(true, [
        'userCount' => (int)$userCount,
        'totalRevenue' => $totalRevenue,
        'activeUsers' => $activeUsers,
        'planMix' => $planMix,
        'history' => [ 'daily' => $daily ],
        'averages' => [
            'conversion' => $conversion,
            'arpu' => $arpu,
            'frequency' => $frequency,
            'totalTx' => $totalTx
        ]
    ]);
}

// ... Resto de funciones administrativas (update_settings, transcode, etc) se asumen presentes
function admin_update_settings($pdo, $input) {
    $allowed = [
        'vipPlans', 'categories', 'videoCommission', 'marketCommission', 'transferFee', 'localLibraryPath'
    ];
    $fields = []; $params = [];
    foreach ($input as $key => $val) {
        if (in_array($key, $allowed)) {
            $fields[] = "`$key` = ?";
            $params[] = (is_array($val) || is_object($val)) ? json_encode($val, JSON_UNESCAPED_UNICODE) : $val;
        }
    }
    if (empty($fields)) respond(true);
    $sql = "UPDATE system_settings SET " . implode(', ', $fields) . " WHERE id = 1";
    $pdo->prepare($sql)->execute($params);
    respond(true);
}
// (Incluir aquí las demás funciones de api/functions_admin.txt si es necesario, 
// pero para brevedad nos enfocamos en el cambio core solicitado)
?>
