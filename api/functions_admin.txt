<?php
/**
 * ADMINISTRACIÓN - CORE FUNCTIONS V19.5 (FFmpeg Transcoder Integrated)
 */

function admin_get_settings($pdo) {
    $stmt = $pdo->query("SELECT * FROM system_settings WHERE id = 1");
    $settings = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($settings) {
        $jsonFields = ['categories', 'libraryPaths', 'vipPlans', 'ftpSettings', 'paymentMethods', 'categoryPrices', 'customCategories', 'categoryHierarchy'];
        foreach ($jsonFields as $field) {
            if (isset($settings[$field]) && is_string($settings[$field])) {
                $decoded = json_decode($settings[$field], true);
                $settings[$field] = $decoded ?: [];
            }
        }
        respond(true, $settings);
    }
    respond(false, null, "No se pudo cargar la configuración");
}

function admin_update_settings($pdo, $input) {
    $allowed = [
        'downloadStartTime', 'downloadEndTime', 'isQueuePaused', 'batchSize', 
        'maxDuration', 'maxResolution', 'ytDlpPath', 'ffmpegPath', 'enableYoutube', 
        'localLibraryPath', 'libraryPaths', 'videoCommission', 'marketCommission', 
        'transferFee', 'vipPlans', 'paymentInstructions', 'currencyConversion', 
        'enableDebugLog', 'autoTranscode', 'transcodePreset', 'proxyUrl', 'ftpSettings', 
        'categories', 'is_transcoder_active', 'tropipayClientId', 'tropipayClientSecret', 
        'geminiKey', 'paymentMethods', 'videoDeliveryMode'
    ];
    $fields = []; $params = [];
    foreach ($input as $key => $val) {
        if (in_array($key, $allowed)) {
            $fields[] = "`$key` = ?";
            $params[] = (is_array($val) || is_object($val)) ? json_encode($val, JSON_UNESCAPED_UNICODE) : $val;
        }
    }
    if (empty($fields)) respond(true);
    $pdo->prepare("UPDATE system_settings SET " . implode(', ', $fields) . " WHERE id = 1")->execute($params);
    respond(true);
}

// --- TRANSCODE ENGINE ---

function admin_get_transcode_profiles($pdo) {
    $stmt = $pdo->query("SELECT * FROM transcode_profiles ORDER BY extension ASC");
    respond(true, $stmt->fetchAll());
}

function admin_save_transcode_profile($pdo, $input) {
    $ext = strtolower(trim($input['extension'] ?? ''));
    $args = trim($input['command_args'] ?? '');
    $desc = trim($input['description'] ?? 'Optimizado');
    if (!$ext || !$args) respond(false, null, "Campos requeridos faltantes");
    $pdo->prepare("REPLACE INTO transcode_profiles (extension, command_args, description) VALUES (?, ?, ?)")->execute([$ext, $args, $desc]);
    respond(true);
}

function admin_delete_transcode_profile($pdo, $ext) {
    $pdo->prepare("DELETE FROM transcode_profiles WHERE extension = ?")->execute([$ext]);
    respond(true);
}

function _admin_perform_transcode_single($pdo, $video, $bins) {
    $realPath = resolve_video_path($video['videoUrl']);
    if (!$realPath || !file_exists($realPath)) {
        $pdo->prepare("UPDATE videos SET transcode_status = 'FAILED', reason = '404: Archivo no encontrado' WHERE id = ?")->execute([$video['id']]);
        return false;
    }

    $ffmpeg = $bins['ffmpeg'];
    $ext = strtolower(pathinfo($realPath, PATHINFO_EXTENSION));
    $stmtP = $pdo->prepare("SELECT command_args FROM transcode_profiles WHERE extension = ?");
    $stmtP->execute([$ext]);
    $args = $stmtP->fetchColumn() ?: "-c:v libx264 -preset ultrafast -pix_fmt yuv420p -c:a aac";
    
    $targetDir = __DIR__ . '/uploads/videos/';
    if (!is_dir($targetDir)) mkdir($targetDir, 0777, true);
    
    $tempFile = $targetDir . 'trans_' . $video['id'] . '.mp4';
    $logFile = __DIR__ . '/transcode_log.txt';
    $cmd = "$ffmpeg -y -i " . escapeshellarg($realPath) . " $args " . escapeshellarg($tempFile) . " 2>> " . escapeshellarg($logFile);
    
    $pdo->prepare("UPDATE videos SET transcode_status = 'PROCESSING' WHERE id = ?")->execute([$video['id']]);
    exec($cmd, $output, $returnCode);
    
    if ($returnCode === 0 && file_exists($tempFile)) {
        $newPath = 'uploads/videos/' . $video['id'] . '.mp4';
        rename($tempFile, __DIR__ . '/' . $newPath);
        $pdo->prepare("UPDATE videos SET videoUrl = ?, transcode_status = 'DONE' WHERE id = ?")->execute([$newPath, $video['id']]);
        return true;
    } else {
        $pdo->prepare("UPDATE videos SET transcode_status = 'FAILED', reason = 'Error FFmpeg: $returnCode' WHERE id = ?")->execute([$video['id']]);
        return false;
    }
}

function admin_process_next_transcode($pdo) {
    $check = shell_exec('pgrep ffmpeg');
    if (!empty($check)) respond(false, null, "FFmpeg ya está en ejecución");
    
    $stmt = $pdo->query("SELECT * FROM videos WHERE transcode_status = 'WAITING' ORDER BY createdAt ASC LIMIT 1");
    $v = $stmt->fetch();
    if (!$v) respond(false, null, "Cola vacía");

    $bins = get_ffmpeg_binaries($pdo);
    if (_admin_perform_transcode_single($pdo, $v, $bins)) respond(true, "Transcodificación exitosa");
    else respond(false, null, "La transcodificación falló");
}

function admin_transcode_scan_filters($pdo, $input) {
    $onlyNonMp4 = !empty($input['onlyNonMp4']);
    $mode = $input['mode'] ?? 'PREVIEW';
    $sql = "SELECT id FROM videos WHERE transcode_status NOT IN ('DONE', 'WAITING', 'PROCESSING')";
    if ($onlyNonMp4) $sql .= " AND videoUrl NOT LIKE '%.mp4'";
    
    $matches = $pdo->query($sql)->fetchAll(PDO::FETCH_COLUMN);
    if ($mode === 'EXECUTE' && !empty($matches)) {
        $ids = implode("','", $matches);
        $pdo->exec("UPDATE videos SET transcode_status = 'WAITING' WHERE id IN ('$ids')");
    }
    respond(true, ['count' => count($matches)]);
}

function admin_retry_failed_transcodes($pdo) {
    $pdo->query("UPDATE videos SET transcode_status = 'WAITING' WHERE transcode_status = 'FAILED'");
    respond(true);
}

function admin_clear_transcode_queue($pdo) {
    $pdo->query("UPDATE videos SET transcode_status = 'NONE' WHERE transcode_status IN ('WAITING', 'FAILED')");
    respond(true);
}

function admin_remove_from_queue($pdo, $id) {
    $pdo->prepare("UPDATE videos SET transcode_status = 'NONE' WHERE id = ?")->execute([$id]);
    respond(true);
}

function admin_skip_transcode($pdo, $id) {
    $pdo->prepare("UPDATE videos SET transcode_status = 'DONE' WHERE id = ?")->execute([$id]);
    respond(true);
}

function admin_get_local_stats($pdo) {
    $stmt = $pdo->query("SELECT libraryPaths, localLibraryPath FROM system_settings WHERE id = 1");
    $sets = $stmt->fetch();
    $paths = json_decode($sets['libraryPaths'] ?: '[]', true);
    if ($sets['localLibraryPath']) $paths[] = $sets['localLibraryPath'];
    
    $volumes = [];
    foreach (array_unique($paths) as $p) {
        if (is_dir($p)) {
            $volumes[] = [
                'name' => basename($p) ?: 'Root',
                'path' => $p,
                'total' => round(@disk_total_space($p) / 1073741824, 1),
                'free' => round(@disk_free_space($p) / 1073741824, 1),
                'video_count' => $pdo->query("SELECT COUNT(*) FROM videos WHERE videoUrl LIKE " . $pdo->quote($p . '%'))->fetchColumn()
            ];
        }
    }
    respond(true, ['volumes' => $volumes, 'category_stats' => $pdo->query("SELECT category, COUNT(*) as count FROM videos GROUP BY category")->fetchAll()]);
}

function get_real_stats($pdo) {
    $from = $_GET['from'] ?? (time() - 2592000);
    $to = $_GET['to'] ?? time();
    $inflow = $pdo->query("SELECT SUM(amount) FROM transactions WHERE isExternal = 1 AND timestamp BETWEEN $from AND $to")->fetchColumn() ?: 0;
    $internal = $pdo->query("SELECT SUM(adminFee) FROM transactions WHERE isExternal = 0 AND timestamp BETWEEN $from AND $to")->fetchColumn() ?: 0;
    $users = $pdo->query("SELECT COUNT(*) FROM users")->fetchColumn();
    
    respond(true, [
        'totalRevenue' => (float)$inflow,
        'internalRevenue' => (float)$internal,
        'userCount' => (int)$users,
        'averages' => ['arpu' => $users > 0 ? round($inflow / $users, 2) : 0, 'conversion' => 10]
    ]);
}

function admin_get_logs() {
    $file = __DIR__ . '/debug_log.txt';
    if (!file_exists($file)) respond(true, []);
    respond(true, array_reverse(array_slice(file($file), -100)));
}

function admin_clear_logs() {
    @file_put_contents(__DIR__ . '/debug_log.txt', '');
    respond(true);
}

function admin_repair_db($pdo, $input) {
    require_once 'functions_schema.php';
    foreach (getAppSchema() as $table => $def) { syncTable($pdo, $table, $def); }
    respond(true, "Base de Datos Reparada");
}

function admin_cleanup_files($pdo) {
    $deleted = 0; $dbFiles = [];
    $vids = $pdo->query("SELECT videoUrl, thumbnailUrl FROM videos")->fetchAll();
    foreach ($vids as $v) { $dbFiles[] = resolve_video_path($v['videoUrl']); $dbFiles[] = resolve_video_path($v['thumbnailUrl']); }
    $dbFiles = array_filter(array_unique($dbFiles));
    
    $dirs = ['uploads/videos', 'uploads/thumbnails', 'uploads/avatars', 'uploads/market'];
    foreach ($dirs as $d) {
        $path = __DIR__ . '/' . $d;
        if (!is_dir($path)) continue;
        foreach (scandir($path) as $f) {
            if ($f === '.' || $f === '..' || strpos($f, 'default') !== false) continue;
            $full = realpath($path . '/' . $f);
            if ($full && !in_array($full, $dbFiles)) { @unlink($full); $deleted++; }
        }
    }
    respond(true, ['videos' => $deleted]);
}

function admin_add_balance($pdo, $input) {
    $uid = $input['userId']; $amount = floatval($input['amount']);
    $pdo->prepare("UPDATE users SET balance = balance + ? WHERE id = ?")->execute([$amount, $uid]);
    $pdo->prepare("INSERT INTO transactions (id, buyerId, amount, type, timestamp, videoTitle, isExternal) VALUES (?, ?, ?, 'DEPOSIT', ?, 'Recarga Admin', 1)")
        ->execute([uniqid('dep_'), $uid, $amount, time()]);
    respond(true);
}
?>