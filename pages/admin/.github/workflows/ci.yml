
name: Build and Release

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Download all-MiniLM-L6-v2 AI Model
      run: |
        mkdir -p dist/models/all-MiniLM-L6-v2
        # Descarga de los archivos esenciales del modelo cuantizado
        curl -L https://huggingface.co/Xenova/all-MiniLM-L6-v2/resolve/main/onnx/model_quantized.onnx -o dist/models/all-MiniLM-L6-v2/model_quantized.onnx
        curl -L https://huggingface.co/Xenova/all-MiniLM-L6-v2/resolve/main/tokenizer.json -o dist/models/all-MiniLM-L6-v2/tokenizer.json
        curl -L https://huggingface.co/Xenova/all-MiniLM-L6-v2/resolve/main/config.json -o dist/models/all-MiniLM-L6-v2/config.json
        curl -L https://huggingface.co/Xenova/all-MiniLM-L6-v2/resolve/main/tokenizer_config.json -o dist/models/all-MiniLM-L6-v2/tokenizer_config.json

    - name: Build project
      run: npm run build

    - name: Prepare Backend Files
      run: |
        mkdir -p dist/api
        cp api/index_code.txt dist/api/index.php
        cp api/install_code.txt dist/api/install.php
        for file in api/functions_*.txt; do
            if [ -f "$file" ]; then
                filename=$(basename "$file" .txt)
                cp "$file" "dist/api/$filename.php"
            fi
        done
        mkdir -p dist/api/uploads/videos
        mkdir -p dist/api/uploads/thumbnails

    - name: Zip Build
      run: |
        cd dist
        zip -r ../streampay-release.zip .
        cd ..

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: streampay-build
        path: streampay-release.zip
